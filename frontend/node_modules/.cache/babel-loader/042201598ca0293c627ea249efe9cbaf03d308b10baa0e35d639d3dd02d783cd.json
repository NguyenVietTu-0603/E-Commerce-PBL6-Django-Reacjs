{"ast":null,"code":"import React,{useCallback,useEffect,useMemo,useRef,useState}from'react';import{useAuth}from'../utils/AuthContext';import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const API_BASE=process.env.REACT_APP_API_BASE||'http://localhost:8000';const formatRelativeTime=isoString=>{if(!isoString)return'';const date=new Date(isoString);const diff=Date.now()-date.getTime();if(diff<60000)return'V·ª´a xong';if(diff<3600000)return\"\".concat(Math.floor(diff/60000),\" ph\\xFAt tr\\u01B0\\u1EDBc\");if(diff<86400000)return\"\".concat(Math.floor(diff/3600000),\" gi\\u1EDD tr\\u01B0\\u1EDBc\");return date.toLocaleDateString('vi-VN');};const normalizeConversation=function(){var _raw$shop,_raw$shop2,_raw$shop3,_raw$buyer,_raw$buyer2,_raw$product,_raw$product2;let raw=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};return{id:raw.id||raw.conversation_id||\"\".concat(raw.shop_id||'shop',\"-\").concat(raw.buyer_id||'buyer'),shopId:raw.shop_id||((_raw$shop=raw.shop)===null||_raw$shop===void 0?void 0:_raw$shop.id)||raw.shopId,shopName:raw.shop_name||((_raw$shop2=raw.shop)===null||_raw$shop2===void 0?void 0:_raw$shop2.name)||raw.shopName||\"Shop #\".concat(raw.shop_id||raw.shopId||'?'),shopAvatar:raw.shop_avatar||((_raw$shop3=raw.shop)===null||_raw$shop3===void 0?void 0:_raw$shop3.avatar),buyerId:raw.buyer_id||((_raw$buyer=raw.buyer)===null||_raw$buyer===void 0?void 0:_raw$buyer.id)||raw.buyerId,buyerName:raw.buyer_name||((_raw$buyer2=raw.buyer)===null||_raw$buyer2===void 0?void 0:_raw$buyer2.full_name)||raw.buyerName||\"Kh\\xE1ch #\".concat(raw.buyer_id||raw.buyerId||'?'),productId:raw.product_id||((_raw$product=raw.product)===null||_raw$product===void 0?void 0:_raw$product.id),productName:raw.product_name||((_raw$product2=raw.product)===null||_raw$product2===void 0?void 0:_raw$product2.name),lastMessage:raw.last_message||raw.lastMessage||'Ch∆∞a c√≥ tin nh·∫Øn',updatedAt:raw.updated_at||raw.last_message_at||raw.updatedAt||new Date().toISOString(),unreadCount:raw.unread_count||raw.unreadCount||0};};const buildFallbackConversations=user=>{if(!user)return[];const now=new Date();return[{id:'demo-1',shopId:user.user_type==='seller'?user.user_id:101,shopName:user.user_type==='seller'?'Shop c·ªßa b·∫°n':'Shop th·ªùi trang',buyerId:user.user_type==='seller'?501:user.user_id,buyerName:user.user_type==='seller'?'Kh√°ch m·ªõi':'B·∫°n',productName:'√Åo cotton form r·ªông',lastMessage:'Xin ch√†o! Shop c√≤n size M kh√¥ng?',updatedAt:now.toISOString(),unreadCount:user.user_type==='seller'?2:0},{id:'demo-2',shopId:user.user_type==='seller'?user.user_id:205,shopName:user.user_type==='seller'?'Shop c·ªßa b·∫°n':'Gi√†y Sneaker Pro',buyerId:user.user_type==='seller'?777:user.user_id,buyerName:user.user_type==='seller'?'Nguy·ªÖn Tr√† My':'B·∫°n',productName:'Sneaker Runner X',lastMessage:'Shop ph·∫£n h·ªìi: S·∫£n ph·∫©m s·∫Ω giao trong h√¥m nay nha!',updatedAt:new Date(now.getTime()-3600000).toISOString(),unreadCount:0}];};const ChatWidget=()=>{const{user}=useAuth();const[drawerOpen,setDrawerOpen]=useState(false);const[conversations,setConversations]=useState([]);const[loading,setLoading]=useState(false);const[error,setError]=useState('');const[activeConversation,setActiveConversation]=useState(null);const hasLoadedRef=useRef(false);const isSeller=(user===null||user===void 0?void 0:user.user_type)==='seller';const fetchConversations=useCallback(async()=>{if(!user)return;setLoading(true);setError('');try{const token=localStorage.getItem('access_token');if(!token)throw new Error('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng chat.');const res=await fetch(\"\".concat(API_BASE,\"/api/chat/conversations/\"),{headers:{Authorization:\"Bearer \".concat(token)}});if(!res.ok)throw new Error('Kh√¥ng th·ªÉ t·∫£i cu·ªôc tr√≤ chuy·ªán.');const data=await res.json();const list=Array.isArray(data===null||data===void 0?void 0:data.results)?data.results:Array.isArray(data)?data:[];setConversations(list.map(normalizeConversation));hasLoadedRef.current=true;}catch(err){console.error('Fetch conversations error:',err);if(!hasLoadedRef.current){setConversations(buildFallbackConversations(user).map(normalizeConversation));}setError(err.message||'ƒê√£ x·∫£y ra l·ªói khi t·∫£i danh s√°ch cu·ªôc tr√≤ chuy·ªán.');}finally{setLoading(false);}},[user]);useEffect(()=>{if(drawerOpen&&!hasLoadedRef.current){fetchConversations();}},[drawerOpen,fetchConversations]);if(!user)return null;const handleConversationClick=conversation=>{setActiveConversation(conversation);};const counterpartLabel=conversation=>{if(!conversation)return'';return isSeller?conversation.buyerName:conversation.shopName;};return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"button\",{className:\"chat-floating-button\",onClick:()=>setDrawerOpen(prev=>!prev),\"aria-label\":\"M\\u1EDF chat\",children:\"\\uD83D\\uDCAC\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"chat-drawer \".concat(drawerOpen?'open':''),children:[/*#__PURE__*/_jsxs(\"div\",{className:\"chat-drawer__header\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"p\",{children:\"H\\u1ED9p th\\u01B0\"}),/*#__PURE__*/_jsx(\"h4\",{children:\"Cu\\u1ED9c tr\\xF2 chuy\\u1EC7n\"})]}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>setDrawerOpen(false),\"aria-label\":\"\\u0110\\xF3ng chat\",children:\"\\xD7\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"chat-drawer__body\",children:[loading&&/*#__PURE__*/_jsx(\"div\",{className:\"chat-drawer__empty\",children:\"\\u0110ang t\\u1EA3i cu\\u1ED9c tr\\xF2 chuy\\u1EC7n...\"}),!loading&&error&&/*#__PURE__*/_jsx(\"div\",{className:\"chat-drawer__error\",children:error}),!loading&&!conversations.length&&!error&&/*#__PURE__*/_jsx(\"div\",{className:\"chat-drawer__empty\",children:\"Ch\\u01B0a c\\xF3 cu\\u1ED9c tr\\xF2 chuy\\u1EC7n n\\xE0o.\"}),/*#__PURE__*/_jsx(\"div\",{className:\"chat-conversation-list\",children:conversations.map(conversation=>{var _counterpartLabel;return/*#__PURE__*/_jsxs(\"button\",{className:\"chat-conversation-item \".concat((activeConversation===null||activeConversation===void 0?void 0:activeConversation.id)===conversation.id?'active':''),onClick:()=>handleConversationClick(conversation),children:[/*#__PURE__*/_jsx(\"div\",{className:\"chat-conversation-item__avatar\",children:conversation.shopAvatar?/*#__PURE__*/_jsx(\"img\",{src:conversation.shopAvatar,alt:conversation.shopName}):/*#__PURE__*/_jsx(\"span\",{children:(_counterpartLabel=counterpartLabel(conversation))===null||_counterpartLabel===void 0?void 0:_counterpartLabel.charAt(0)})}),/*#__PURE__*/_jsxs(\"div\",{className:\"chat-conversation-item__content\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"chat-conversation-item__row\",children:[/*#__PURE__*/_jsx(\"strong\",{children:counterpartLabel(conversation)}),/*#__PURE__*/_jsx(\"span\",{children:formatRelativeTime(conversation.updatedAt)})]}),/*#__PURE__*/_jsxs(\"p\",{children:[conversation.productName&&/*#__PURE__*/_jsxs(\"em\",{children:[conversation.productName,\" \\u2022 \"]}),conversation.lastMessage]})]}),conversation.unreadCount>0&&/*#__PURE__*/_jsx(\"span\",{className:\"chat-conversation-item__badge\",children:conversation.unreadCount})]},conversation.id);})})]})]}),activeConversation&&/*#__PURE__*/_jsx(ChatPopup,{conversation:activeConversation,onClose:()=>setActiveConversation(null),isSeller:isSeller,counterpartName:counterpartLabel(activeConversation)})]});};const ChatPopup=_ref=>{let{conversation,onClose,isSeller,counterpartName}=_ref;const{user}=useAuth();const[messages,setMessages]=useState([]);const[text,setText]=useState('');const[connecting,setConnecting]=useState(false);const wsRef=useRef(null);const bottomRef=useRef(null);const shopId=useMemo(()=>{if(isSeller)return conversation.shopId||(user===null||user===void 0?void 0:user.user_id);return conversation.shopId;},[conversation.shopId,isSeller,user===null||user===void 0?void 0:user.user_id]);const buyerParam=useMemo(()=>{if(isSeller)return conversation.buyerId;return user===null||user===void 0?void 0:user.user_id;},[conversation.buyerId,isSeller,user===null||user===void 0?void 0:user.user_id]);useEffect(()=>{if(!conversation||!shopId||!buyerParam||!user)return;const token=localStorage.getItem('access_token')||'';const raw=API_BASE.replace(/^https?:\\/\\//,'');const wsProtocol=API_BASE.startsWith('https')?'wss':'ws';const qs=new URLSearchParams({token,buyer:buyerParam});if(conversation.productId)qs.set('product',conversation.productId);const wsUrl=\"\".concat(wsProtocol,\"://\").concat(raw,\"/ws/chat/\").concat(shopId,\"/?\").concat(qs.toString());const ws=new WebSocket(wsUrl);wsRef.current=ws;setConnecting(true);ws.onopen=()=>setConnecting(false);ws.onmessage=evt=>{try{const data=JSON.parse(evt.data);if(data.type==='history')setMessages(data.messages||[]);else if(data.type==='message'&&data.message)setMessages(prev=>[...prev,data.message]);}catch(error){console.error('WS parse error',error);}};ws.onclose=evt=>console.log('Chat popup WS closed',evt);ws.onerror=error=>console.error('Chat popup WS error',error);return()=>ws.close();},[conversation===null||conversation===void 0?void 0:conversation.id,conversation.productId,buyerParam,shopId,user]);useEffect(()=>{var _bottomRef$current;(_bottomRef$current=bottomRef.current)===null||_bottomRef$current===void 0?void 0:_bottomRef$current.scrollIntoView({behavior:'smooth'});},[messages]);const sendMessage=()=>{const content=text.trim();if(!content||!wsRef.current||wsRef.current.readyState!==1)return;wsRef.current.send(JSON.stringify({type:'message',content}));setText('');};return/*#__PURE__*/_jsxs(\"div\",{className:\"chat-popup\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"chat-popup__header\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"p\",{children:conversation.productName||'Tr√≤ chuy·ªán'}),/*#__PURE__*/_jsx(\"strong\",{children:counterpartName})]}),/*#__PURE__*/_jsx(\"button\",{onClick:onClose,\"aria-label\":\"\\u0110\\xF3ng cu\\u1ED9c tr\\xF2 chuy\\u1EC7n\",children:\"\\xD7\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"chat-popup__body\",children:[connecting&&/*#__PURE__*/_jsx(\"div\",{className:\"chat-popup__info\",children:\"\\u0110ang k\\u1EBFt n\\u1ED1i...\"}),messages.map(message=>/*#__PURE__*/_jsx(\"div\",{className:\"chat-popup__message \".concat(message.sender_id===(user===null||user===void 0?void 0:user.user_id)?'me':''),children:/*#__PURE__*/_jsxs(\"div\",{className:\"chat-popup__bubble\",children:[/*#__PURE__*/_jsx(\"div\",{children:message.content}),/*#__PURE__*/_jsx(\"span\",{children:new Date(message.created_at).toLocaleString('vi-VN')})]})},message.id||\"\".concat(message.created_at,\"-\").concat(message.sender_id))),/*#__PURE__*/_jsx(\"div\",{ref:bottomRef})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"chat-popup__footer\",children:[/*#__PURE__*/_jsx(\"input\",{value:text,onChange:e=>setText(e.target.value),onKeyDown:e=>e.key==='Enter'&&sendMessage(),placeholder:\"Nh\\u1EADp n\\u1ED9i dung...\"}),/*#__PURE__*/_jsx(\"button\",{onClick:sendMessage,children:\"G\\u1EEDi\"})]})]});};export default ChatWidget;","map":{"version":3,"names":["React","useCallback","useEffect","useMemo","useRef","useState","useAuth","jsx","_jsx","jsxs","_jsxs","Fragment","_Fragment","API_BASE","process","env","REACT_APP_API_BASE","formatRelativeTime","isoString","date","Date","diff","now","getTime","concat","Math","floor","toLocaleDateString","normalizeConversation","_raw$shop","_raw$shop2","_raw$shop3","_raw$buyer","_raw$buyer2","_raw$product","_raw$product2","raw","arguments","length","undefined","id","conversation_id","shop_id","buyer_id","shopId","shop","shopName","shop_name","name","shopAvatar","shop_avatar","avatar","buyerId","buyer","buyerName","buyer_name","full_name","productId","product_id","product","productName","product_name","lastMessage","last_message","updatedAt","updated_at","last_message_at","toISOString","unreadCount","unread_count","buildFallbackConversations","user","user_type","user_id","ChatWidget","drawerOpen","setDrawerOpen","conversations","setConversations","loading","setLoading","error","setError","activeConversation","setActiveConversation","hasLoadedRef","isSeller","fetchConversations","token","localStorage","getItem","Error","res","fetch","headers","Authorization","ok","data","json","list","Array","isArray","results","map","current","err","console","message","handleConversationClick","conversation","counterpartLabel","children","className","onClick","prev","_counterpartLabel","src","alt","charAt","ChatPopup","onClose","counterpartName","_ref","messages","setMessages","text","setText","connecting","setConnecting","wsRef","bottomRef","buyerParam","replace","wsProtocol","startsWith","qs","URLSearchParams","set","wsUrl","toString","ws","WebSocket","onopen","onmessage","evt","JSON","parse","type","onclose","log","onerror","close","_bottomRef$current","scrollIntoView","behavior","sendMessage","content","trim","readyState","send","stringify","sender_id","created_at","toLocaleString","ref","value","onChange","e","target","onKeyDown","key","placeholder"],"sources":["C:/VIET/PBL6/main/frontend/src/components/ChatWidget.jsx"],"sourcesContent":["import React, { useCallback, useEffect, useMemo, useRef, useState } from 'react';\r\nimport { useAuth } from '../utils/AuthContext';\r\n\r\nconst API_BASE = process.env.REACT_APP_API_BASE || 'http://localhost:8000';\r\n\r\nconst formatRelativeTime = (isoString) => {\r\n  if (!isoString) return '';\r\n  const date = new Date(isoString);\r\n  const diff = Date.now() - date.getTime();\r\n  if (diff < 60000) return 'V·ª´a xong';\r\n  if (diff < 3600000) return `${Math.floor(diff / 60000)} ph√∫t tr∆∞·ªõc`;\r\n  if (diff < 86400000) return `${Math.floor(diff / 3600000)} gi·ªù tr∆∞·ªõc`;\r\n  return date.toLocaleDateString('vi-VN');\r\n};\r\n\r\nconst normalizeConversation = (raw = {}) => ({\r\n  id: raw.id || raw.conversation_id || `${raw.shop_id || 'shop'}-${raw.buyer_id || 'buyer'}`,\r\n  shopId: raw.shop_id || raw.shop?.id || raw.shopId,\r\n  shopName: raw.shop_name || raw.shop?.name || raw.shopName || `Shop #${raw.shop_id || raw.shopId || '?'}`,\r\n  shopAvatar: raw.shop_avatar || raw.shop?.avatar,\r\n  buyerId: raw.buyer_id || raw.buyer?.id || raw.buyerId,\r\n  buyerName: raw.buyer_name || raw.buyer?.full_name || raw.buyerName || `Kh√°ch #${raw.buyer_id || raw.buyerId || '?'}`,\r\n  productId: raw.product_id || raw.product?.id,\r\n  productName: raw.product_name || raw.product?.name,\r\n  lastMessage: raw.last_message || raw.lastMessage || 'Ch∆∞a c√≥ tin nh·∫Øn',\r\n  updatedAt: raw.updated_at || raw.last_message_at || raw.updatedAt || new Date().toISOString(),\r\n  unreadCount: raw.unread_count || raw.unreadCount || 0,\r\n});\r\n\r\nconst buildFallbackConversations = (user) => {\r\n  if (!user) return [];\r\n  const now = new Date();\r\n  return [\r\n    {\r\n      id: 'demo-1',\r\n      shopId: user.user_type === 'seller' ? user.user_id : 101,\r\n      shopName: user.user_type === 'seller' ? 'Shop c·ªßa b·∫°n' : 'Shop th·ªùi trang',\r\n      buyerId: user.user_type === 'seller' ? 501 : user.user_id,\r\n      buyerName: user.user_type === 'seller' ? 'Kh√°ch m·ªõi' : 'B·∫°n',\r\n      productName: '√Åo cotton form r·ªông',\r\n      lastMessage: 'Xin ch√†o! Shop c√≤n size M kh√¥ng?',\r\n      updatedAt: now.toISOString(),\r\n      unreadCount: user.user_type === 'seller' ? 2 : 0,\r\n    },\r\n    {\r\n      id: 'demo-2',\r\n      shopId: user.user_type === 'seller' ? user.user_id : 205,\r\n      shopName: user.user_type === 'seller' ? 'Shop c·ªßa b·∫°n' : 'Gi√†y Sneaker Pro',\r\n      buyerId: user.user_type === 'seller' ? 777 : user.user_id,\r\n      buyerName: user.user_type === 'seller' ? 'Nguy·ªÖn Tr√† My' : 'B·∫°n',\r\n      productName: 'Sneaker Runner X',\r\n      lastMessage: 'Shop ph·∫£n h·ªìi: S·∫£n ph·∫©m s·∫Ω giao trong h√¥m nay nha!',\r\n      updatedAt: new Date(now.getTime() - 3600000).toISOString(),\r\n      unreadCount: 0,\r\n    },\r\n  ];\r\n};\r\n\r\nconst ChatWidget = () => {\r\n  const { user } = useAuth();\r\n  const [drawerOpen, setDrawerOpen] = useState(false);\r\n  const [conversations, setConversations] = useState([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState('');\r\n  const [activeConversation, setActiveConversation] = useState(null);\r\n  const hasLoadedRef = useRef(false);\r\n\r\n  const isSeller = user?.user_type === 'seller';\r\n\r\n  const fetchConversations = useCallback(async () => {\r\n    if (!user) return;\r\n    setLoading(true);\r\n    setError('');\r\n    try {\r\n      const token = localStorage.getItem('access_token');\r\n      if (!token) throw new Error('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng chat.');\r\n      const res = await fetch(`${API_BASE}/api/chat/conversations/`, {\r\n        headers: {\r\n          Authorization: `Bearer ${token}`,\r\n        },\r\n      });\r\n      if (!res.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i cu·ªôc tr√≤ chuy·ªán.');\r\n      const data = await res.json();\r\n      const list = Array.isArray(data?.results) ? data.results : Array.isArray(data) ? data : [];\r\n      setConversations(list.map(normalizeConversation));\r\n      hasLoadedRef.current = true;\r\n    } catch (err) {\r\n      console.error('Fetch conversations error:', err);\r\n      if (!hasLoadedRef.current) {\r\n        setConversations(buildFallbackConversations(user).map(normalizeConversation));\r\n      }\r\n      setError(err.message || 'ƒê√£ x·∫£y ra l·ªói khi t·∫£i danh s√°ch cu·ªôc tr√≤ chuy·ªán.');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [user]);\r\n\r\n  useEffect(() => {\r\n    if (drawerOpen && !hasLoadedRef.current) {\r\n      fetchConversations();\r\n    }\r\n  }, [drawerOpen, fetchConversations]);\r\n\r\n  if (!user) return null;\r\n\r\n  const handleConversationClick = (conversation) => {\r\n    setActiveConversation(conversation);\r\n  };\r\n\r\n  const counterpartLabel = (conversation) => {\r\n    if (!conversation) return '';\r\n    return isSeller ? conversation.buyerName : conversation.shopName;\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <button\r\n        className=\"chat-floating-button\"\r\n        onClick={() => setDrawerOpen((prev) => !prev)}\r\n        aria-label=\"M·ªü chat\"\r\n      >\r\n        üí¨\r\n      </button>\r\n\r\n      <div className={`chat-drawer ${drawerOpen ? 'open' : ''}`}>\r\n        <div className=\"chat-drawer__header\">\r\n          <div>\r\n            <p>H·ªôp th∆∞</p>\r\n            <h4>Cu·ªôc tr√≤ chuy·ªán</h4>\r\n          </div>\r\n          <button onClick={() => setDrawerOpen(false)} aria-label=\"ƒê√≥ng chat\">√ó</button>\r\n        </div>\r\n\r\n        <div className=\"chat-drawer__body\">\r\n          {loading && <div className=\"chat-drawer__empty\">ƒêang t·∫£i cu·ªôc tr√≤ chuy·ªán...</div>}\r\n          {!loading && error && <div className=\"chat-drawer__error\">{error}</div>}\r\n          {!loading && !conversations.length && !error && (\r\n            <div className=\"chat-drawer__empty\">Ch∆∞a c√≥ cu·ªôc tr√≤ chuy·ªán n√†o.</div>\r\n          )}\r\n\r\n          <div className=\"chat-conversation-list\">\r\n            {conversations.map((conversation) => (\r\n              <button\r\n                key={conversation.id}\r\n                className={`chat-conversation-item ${\r\n                  activeConversation?.id === conversation.id ? 'active' : ''\r\n                }`}\r\n                onClick={() => handleConversationClick(conversation)}\r\n              >\r\n                <div className=\"chat-conversation-item__avatar\">\r\n                  {conversation.shopAvatar ? (\r\n                    <img src={conversation.shopAvatar} alt={conversation.shopName} />\r\n                  ) : (\r\n                    <span>{counterpartLabel(conversation)?.charAt(0)}</span>\r\n                  )}\r\n                </div>\r\n                <div className=\"chat-conversation-item__content\">\r\n                  <div className=\"chat-conversation-item__row\">\r\n                    <strong>{counterpartLabel(conversation)}</strong>\r\n                    <span>{formatRelativeTime(conversation.updatedAt)}</span>\r\n                  </div>\r\n                  <p>\r\n                    {conversation.productName && <em>{conversation.productName} ‚Ä¢ </em>}\r\n                    {conversation.lastMessage}\r\n                  </p>\r\n                </div>\r\n                {conversation.unreadCount > 0 && (\r\n                  <span className=\"chat-conversation-item__badge\">{conversation.unreadCount}</span>\r\n                )}\r\n              </button>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {activeConversation && (\r\n        <ChatPopup\r\n          conversation={activeConversation}\r\n          onClose={() => setActiveConversation(null)}\r\n          isSeller={isSeller}\r\n          counterpartName={counterpartLabel(activeConversation)}\r\n        />\r\n      )}\r\n    </>\r\n  );\r\n};\r\n\r\nconst ChatPopup = ({ conversation, onClose, isSeller, counterpartName }) => {\r\n  const { user } = useAuth();\r\n  const [messages, setMessages] = useState([]);\r\n  const [text, setText] = useState('');\r\n  const [connecting, setConnecting] = useState(false);\r\n  const wsRef = useRef(null);\r\n  const bottomRef = useRef(null);\r\n\r\n  const shopId = useMemo(() => {\r\n    if (isSeller) return conversation.shopId || user?.user_id;\r\n    return conversation.shopId;\r\n  }, [conversation.shopId, isSeller, user?.user_id]);\r\n\r\n  const buyerParam = useMemo(() => {\r\n    if (isSeller) return conversation.buyerId;\r\n    return user?.user_id;\r\n  }, [conversation.buyerId, isSeller, user?.user_id]);\r\n\r\n  useEffect(() => {\r\n    if (!conversation || !shopId || !buyerParam || !user) return;\r\n\r\n    const token = localStorage.getItem('access_token') || '';\r\n    const raw = API_BASE.replace(/^https?:\\/\\//, '');\r\n    const wsProtocol = API_BASE.startsWith('https') ? 'wss' : 'ws';\r\n    const qs = new URLSearchParams({ token, buyer: buyerParam });\r\n    if (conversation.productId) qs.set('product', conversation.productId);\r\n\r\n    const wsUrl = `${wsProtocol}://${raw}/ws/chat/${shopId}/?${qs.toString()}`;\r\n    const ws = new WebSocket(wsUrl);\r\n    wsRef.current = ws;\r\n    setConnecting(true);\r\n\r\n    ws.onopen = () => setConnecting(false);\r\n    ws.onmessage = (evt) => {\r\n      try {\r\n        const data = JSON.parse(evt.data);\r\n        if (data.type === 'history') setMessages(data.messages || []);\r\n        else if (data.type === 'message' && data.message) setMessages((prev) => [...prev, data.message]);\r\n      } catch (error) {\r\n        console.error('WS parse error', error);\r\n      }\r\n    };\r\n    ws.onclose = (evt) => console.log('Chat popup WS closed', evt);\r\n    ws.onerror = (error) => console.error('Chat popup WS error', error);\r\n\r\n    return () => ws.close();\r\n  }, [conversation?.id, conversation.productId, buyerParam, shopId, user]);\r\n\r\n  useEffect(() => {\r\n    bottomRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n  }, [messages]);\r\n\r\n  const sendMessage = () => {\r\n    const content = text.trim();\r\n    if (!content || !wsRef.current || wsRef.current.readyState !== 1) return;\r\n    wsRef.current.send(JSON.stringify({ type: 'message', content }));\r\n    setText('');\r\n  };\r\n\r\n  return (\r\n    <div className=\"chat-popup\">\r\n      <div className=\"chat-popup__header\">\r\n        <div>\r\n          <p>{conversation.productName || 'Tr√≤ chuy·ªán'}</p>\r\n          <strong>{counterpartName}</strong>\r\n        </div>\r\n        <button onClick={onClose} aria-label=\"ƒê√≥ng cu·ªôc tr√≤ chuy·ªán\">√ó</button>\r\n      </div>\r\n\r\n      <div className=\"chat-popup__body\">\r\n        {connecting && <div className=\"chat-popup__info\">ƒêang k·∫øt n·ªëi...</div>}\r\n        {messages.map((message) => (\r\n          <div\r\n            key={message.id || `${message.created_at}-${message.sender_id}`}\r\n            className={`chat-popup__message ${message.sender_id === user?.user_id ? 'me' : ''}`}\r\n          >\r\n            <div className=\"chat-popup__bubble\">\r\n              <div>{message.content}</div>\r\n              <span>{new Date(message.created_at).toLocaleString('vi-VN')}</span>\r\n            </div>\r\n          </div>\r\n        ))}\r\n        <div ref={bottomRef} />\r\n      </div>\r\n\r\n      <div className=\"chat-popup__footer\">\r\n        <input\r\n          value={text}\r\n          onChange={(e) => setText(e.target.value)}\r\n          onKeyDown={(e) => e.key === 'Enter' && sendMessage()}\r\n          placeholder=\"Nh·∫≠p n·ªôi dung...\"\r\n        />\r\n        <button onClick={sendMessage}>G·ª≠i</button>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ChatWidget;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}