{"ast":null,"code":"import React,{useEffect,useRef,useState}from'react';import{useParams,useNavigate,Link}from'react-router-dom';import{useAuth}from'../utils/AuthContext';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const API_BASE=process.env.REACT_APP_API_BASE||'http://localhost:8000';export default function ShopChat(){const{shopId,buyerId}=useParams();const{user}=useAuth();const navigate=useNavigate();const[messages,setMessages]=useState([]);const[text,setText]=useState('');const wsRef=useRef(null);const bottomRef=useRef(null);useEffect(()=>{if(!user){navigate('/login');return;}const token=localStorage.getItem('access_token')||'';const raw=API_BASE.replace(/^https?:\\/\\//,'');const wsProtocol=API_BASE.startsWith('https')?'wss':'ws';const qs=new URLSearchParams({token});if(buyerId)qs.set('buyer',buyerId);const wsUrl=\"\".concat(wsProtocol,\"://\").concat(raw,\"/ws/chat/\").concat(shopId,\"/?\").concat(qs.toString());const ws=new WebSocket(wsUrl);wsRef.current=ws;ws.onopen=()=>console.log('WS connected (shop)');ws.onmessage=evt=>{try{const data=JSON.parse(evt.data);if(data.type==='history')setMessages(data.messages||[]);else if(data.type==='message'&&data.message)setMessages(prev=>[...prev,data.message]);}catch(_unused){}};ws.onclose=evt=>console.log('WS closed',evt);ws.onerror=e=>console.log('WS error',e);return()=>ws.close();},[shopId,buyerId,user,navigate]);useEffect(()=>{var _bottomRef$current;(_bottomRef$current=bottomRef.current)===null||_bottomRef$current===void 0?void 0:_bottomRef$current.scrollIntoView({behavior:'smooth'});},[messages]);const sendMessage=()=>{const content=text.trim();if(!content||!wsRef.current||wsRef.current.readyState!==1)return;wsRef.current.send(JSON.stringify({type:'message',content}));setText('');};if(!user)return null;return/*#__PURE__*/_jsxs(\"div\",{style:{maxWidth:900,margin:'20px auto',background:'#fff',border:'1px solid #eee',borderRadius:8,display:'flex',flexDirection:'column',height:'80vh'},children:[/*#__PURE__*/_jsx(\"div\",{style:{padding:12,borderBottom:'1px solid #eee',display:'flex',justifyContent:'space-between',alignItems:'center'},children:/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Link,{to:\"/\",style:{marginRight:12},children:\"\\u2190 Trang ch\\u1EE7\"}),/*#__PURE__*/_jsxs(\"strong\",{children:[\"Shop #\",shopId,\" chat v\\u1EDBi buyer #\",buyerId]})]})}),/*#__PURE__*/_jsxs(\"div\",{style:{flex:1,overflowY:'auto',padding:12},children:[messages.map(m=>/*#__PURE__*/_jsx(\"div\",{style:{marginBottom:8,display:'flex',justifyContent:m.sender_id===user.user_id?'flex-end':'flex-start'},children:/*#__PURE__*/_jsxs(\"div\",{style:{maxWidth:'70%',padding:'8px 12px',borderRadius:12,background:m.sender_id===user.user_id?'#DCFCE7':'#F3F4F6'},children:[/*#__PURE__*/_jsx(\"div\",{style:{fontSize:14},children:m.content}),/*#__PURE__*/_jsx(\"div\",{style:{fontSize:11,color:'#6b7280',marginTop:4},children:new Date(m.created_at).toLocaleString('vi-VN')})]})},m.id)),/*#__PURE__*/_jsx(\"div\",{ref:bottomRef})]}),/*#__PURE__*/_jsxs(\"div\",{style:{padding:12,borderTop:'1px solid #eee',display:'flex',gap:8},children:[/*#__PURE__*/_jsx(\"input\",{value:text,onChange:e=>setText(e.target.value),onKeyDown:e=>e.key==='Enter'&&sendMessage(),placeholder:\"Nh\\u1EADp n\\u1ED9i dung...\",style:{flex:1,padding:'10px 12px',border:'1px solid #ddd',borderRadius:8}}),/*#__PURE__*/_jsx(\"button\",{onClick:sendMessage,style:{padding:'10px 16px',background:'#2563eb',color:'#fff',border:'none',borderRadius:8},children:\"G\\u1EEDi\"})]})]});}","map":{"version":3,"names":["React","useEffect","useRef","useState","useParams","useNavigate","Link","useAuth","jsx","_jsx","jsxs","_jsxs","API_BASE","process","env","REACT_APP_API_BASE","ShopChat","shopId","buyerId","user","navigate","messages","setMessages","text","setText","wsRef","bottomRef","token","localStorage","getItem","raw","replace","wsProtocol","startsWith","qs","URLSearchParams","set","wsUrl","concat","toString","ws","WebSocket","current","onopen","console","log","onmessage","evt","data","JSON","parse","type","message","prev","_unused","onclose","onerror","e","close","_bottomRef$current","scrollIntoView","behavior","sendMessage","content","trim","readyState","send","stringify","style","maxWidth","margin","background","border","borderRadius","display","flexDirection","height","children","padding","borderBottom","justifyContent","alignItems","to","marginRight","flex","overflowY","map","m","marginBottom","sender_id","user_id","fontSize","color","marginTop","Date","created_at","toLocaleString","id","ref","borderTop","gap","value","onChange","target","onKeyDown","key","placeholder","onClick"],"sources":["C:/VIET/PBL6/main/frontend/src/pages/ShopChat.jsx"],"sourcesContent":["import React, { useEffect, useRef, useState } from 'react';\r\nimport { useParams, useNavigate, Link } from 'react-router-dom';\r\nimport { useAuth } from '../utils/AuthContext';\r\n\r\nconst API_BASE = process.env.REACT_APP_API_BASE || 'http://localhost:8000';\r\n\r\nexport default function ShopChat() {\r\n  const { shopId, buyerId } = useParams();\r\n  const { user } = useAuth();\r\n  const navigate = useNavigate();\r\n  const [messages, setMessages] = useState([]);\r\n  const [text, setText] = useState('');\r\n  const wsRef = useRef(null);\r\n  const bottomRef = useRef(null);\r\n\r\n  useEffect(() => {\r\n    if (!user) {\r\n      navigate('/login');\r\n      return;\r\n    }\r\n\r\n    const token = localStorage.getItem('access_token') || '';\r\n    const raw = API_BASE.replace(/^https?:\\/\\//,'');\r\n    const wsProtocol = API_BASE.startsWith('https') ? 'wss' : 'ws';\r\n\r\n    const qs = new URLSearchParams({ token });\r\n    if (buyerId) qs.set('buyer', buyerId);\r\n\r\n    const wsUrl = `${wsProtocol}://${raw}/ws/chat/${shopId}/?${qs.toString()}`;\r\n    const ws = new WebSocket(wsUrl);\r\n    wsRef.current = ws;\r\n\r\n    ws.onopen = () => console.log('WS connected (shop)');\r\n    ws.onmessage = (evt) => {\r\n      try {\r\n        const data = JSON.parse(evt.data);\r\n        if (data.type === 'history') setMessages(data.messages || []);\r\n        else if (data.type === 'message' && data.message) setMessages(prev => [...prev, data.message]);\r\n      } catch {}\r\n    };\r\n    ws.onclose = (evt) => console.log('WS closed', evt);\r\n    ws.onerror = (e) => console.log('WS error', e);\r\n\r\n    return () => ws.close();\r\n  }, [shopId, buyerId, user, navigate]);\r\n\r\n  useEffect(() => {\r\n    bottomRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n  }, [messages]);\r\n\r\n  const sendMessage = () => {\r\n    const content = text.trim();\r\n    if (!content || !wsRef.current || wsRef.current.readyState !== 1) return;\r\n    wsRef.current.send(JSON.stringify({ type: 'message', content }));\r\n    setText('');\r\n  };\r\n\r\n  if (!user) return null;\r\n\r\n  return (\r\n    <div style={{maxWidth:900, margin:'20px auto', background:'#fff', border:'1px solid #eee', borderRadius:8, display:'flex', flexDirection:'column', height:'80vh'}}>\r\n      <div style={{padding:12, borderBottom:'1px solid #eee', display:'flex', justifyContent:'space-between', alignItems:'center'}}>\r\n        <div>\r\n          <Link to=\"/\" style={{marginRight:12}}>&larr; Trang chủ</Link>\r\n          <strong>Shop #{shopId} chat với buyer #{buyerId}</strong>\r\n        </div>\r\n      </div>\r\n      <div style={{flex:1, overflowY:'auto', padding:12}}>\r\n        {messages.map(m => (\r\n          <div key={m.id} style={{marginBottom:8, display:'flex', justifyContent: m.sender_id === user.user_id ? 'flex-end' : 'flex-start'}}>\r\n            <div style={{maxWidth:'70%', padding:'8px 12px', borderRadius:12, background: m.sender_id === user.user_id ? '#DCFCE7' : '#F3F4F6'}}>\r\n              <div style={{fontSize:14}}>{m.content}</div>\r\n              <div style={{fontSize:11, color:'#6b7280', marginTop:4}}>{new Date(m.created_at).toLocaleString('vi-VN')}</div>\r\n            </div>\r\n          </div>\r\n        ))}\r\n        <div ref={bottomRef} />\r\n      </div>\r\n      <div style={{padding:12, borderTop:'1px solid #eee', display:'flex', gap:8}}>\r\n        <input\r\n          value={text}\r\n          onChange={e => setText(e.target.value)}\r\n          onKeyDown={e => e.key==='Enter' && sendMessage()}\r\n          placeholder=\"Nhập nội dung...\"\r\n          style={{flex:1, padding:'10px 12px', border:'1px solid #ddd', borderRadius:8}}\r\n        />\r\n        <button onClick={sendMessage} style={{padding:'10px 16px', background:'#2563eb', color:'#fff', border:'none', borderRadius:8}}>Gửi</button>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}