{"ast":null,"code":"// Chat.jsx (buyer chat với shop)\nimport React,{useEffect,useRef,useState}from'react';import{useParams,useNavigate,Link}from'react-router-dom';import{useAuth}from'../utils/AuthContext';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const API_BASE=process.env.REACT_APP_API_BASE||'http://localhost:8000';export default function Chat(){const{shopId}=useParams();// :shopId từ URL\nconst{user}=useAuth();const navigate=useNavigate();const[messages,setMessages]=useState([]);const[text,setText]=useState('');const wsRef=useRef(null);const bottomRef=useRef(null);useEffect(()=>{if(!user){navigate('/login');return;}const token=localStorage.getItem('access_token')||'';const raw=API_BASE.replace(/^https?:\\/\\//,'');const wsProtocol=API_BASE.startsWith('https')?'wss':'ws';const params=new URLSearchParams(window.location.search);const product=params.get('product');const qs=new URLSearchParams({token});if(product)qs.set('product',product);// Gửi luôn buyerId (user hiện tại) để backend phân biệt conversation\nqs.set('buyer',user.user_id);const wsUrl=\"\".concat(wsProtocol,\"://\").concat(raw,\"/ws/chat/\").concat(shopId,\"/?\").concat(qs.toString());const ws=new WebSocket(wsUrl);wsRef.current=ws;ws.onopen=()=>console.log('WS connected (buyer)');ws.onmessage=evt=>{try{const data=JSON.parse(evt.data);if(data.type==='history')setMessages(data.messages||[]);else if(data.type==='message'&&data.message)setMessages(prev=>[...prev,data.message]);}catch(err){console.error('WS parse error:',err);}};ws.onclose=evt=>console.error('WS closed',{code:evt.code,reason:evt.reason});ws.onerror=e=>console.error('WS error',e);return()=>ws.close();},[shopId,user,navigate]);useEffect(()=>{var _bottomRef$current;(_bottomRef$current=bottomRef.current)===null||_bottomRef$current===void 0?void 0:_bottomRef$current.scrollIntoView({behavior:'smooth'});},[messages]);const sendMessage=()=>{const content=text.trim();if(!content||!wsRef.current||wsRef.current.readyState!==1)return;wsRef.current.send(JSON.stringify({type:'message',content}));setText('');};if(!user)return null;return/*#__PURE__*/_jsxs(\"div\",{style:{maxWidth:900,margin:'20px auto',display:'flex',flexDirection:'column',height:'80vh',background:'#fff',border:'1px solid #eee',borderRadius:8},children:[/*#__PURE__*/_jsxs(\"div\",{style:{padding:12,borderBottom:'1px solid #eee',display:'flex',alignItems:'center',justifyContent:'space-between'},children:[/*#__PURE__*/_jsx(Link,{to:\"/\",children:\"\\u2190 Trang ch\\u1EE7\"}),/*#__PURE__*/_jsxs(\"strong\",{children:[\"Chat v\\u1EDBi shop #\",shopId]})]}),/*#__PURE__*/_jsxs(\"div\",{style:{flex:1,overflowY:'auto',padding:12},children:[messages.map(m=>/*#__PURE__*/_jsx(\"div\",{style:{marginBottom:8,display:'flex',justifyContent:m.sender_id===(user===null||user===void 0?void 0:user.user_id)?'flex-end':'flex-start'},children:/*#__PURE__*/_jsxs(\"div\",{style:{maxWidth:'70%',padding:'8px 12px',borderRadius:12,background:m.sender_id===(user===null||user===void 0?void 0:user.user_id)?'#DCFCE7':'#F3F4F6'},children:[/*#__PURE__*/_jsx(\"div\",{style:{fontSize:14},children:m.content}),/*#__PURE__*/_jsx(\"div\",{style:{fontSize:11,color:'#6b7280',marginTop:4},children:new Date(m.created_at).toLocaleString('vi-VN')})]})},m.id)),/*#__PURE__*/_jsx(\"div\",{ref:bottomRef})]}),/*#__PURE__*/_jsxs(\"div\",{style:{padding:12,display:'flex',gap:8,borderTop:'1px solid #eee'},children:[/*#__PURE__*/_jsx(\"input\",{value:text,onChange:e=>setText(e.target.value),onKeyDown:e=>e.key==='Enter'&&sendMessage(),placeholder:\"Nh\\u1EADp n\\u1ED9i dung...\",style:{flex:1,padding:'10px 12px',border:'1px solid #ddd',borderRadius:8}}),/*#__PURE__*/_jsx(\"button\",{onClick:sendMessage,style:{padding:'10px 16px',background:'#2563eb',color:'#fff',border:'none',borderRadius:8},children:\"G\\u1EEDi\"})]})]});}","map":{"version":3,"names":["React","useEffect","useRef","useState","useParams","useNavigate","Link","useAuth","jsx","_jsx","jsxs","_jsxs","API_BASE","process","env","REACT_APP_API_BASE","Chat","shopId","user","navigate","messages","setMessages","text","setText","wsRef","bottomRef","token","localStorage","getItem","raw","replace","wsProtocol","startsWith","params","URLSearchParams","window","location","search","product","get","qs","set","user_id","wsUrl","concat","toString","ws","WebSocket","current","onopen","console","log","onmessage","evt","data","JSON","parse","type","message","prev","err","error","onclose","code","reason","onerror","e","close","_bottomRef$current","scrollIntoView","behavior","sendMessage","content","trim","readyState","send","stringify","style","maxWidth","margin","display","flexDirection","height","background","border","borderRadius","children","padding","borderBottom","alignItems","justifyContent","to","flex","overflowY","map","m","marginBottom","sender_id","fontSize","color","marginTop","Date","created_at","toLocaleString","id","ref","gap","borderTop","value","onChange","target","onKeyDown","key","placeholder","onClick"],"sources":["C:/VIET/PBL6/main/frontend/src/pages/Chat.jsx"],"sourcesContent":["// Chat.jsx (buyer chat với shop)\r\nimport React, { useEffect, useRef, useState } from 'react';\r\nimport { useParams, useNavigate, Link } from 'react-router-dom';\r\nimport { useAuth } from '../utils/AuthContext';\r\n\r\nconst API_BASE = process.env.REACT_APP_API_BASE || 'http://localhost:8000';\r\n\r\nexport default function Chat() {\r\n  const { shopId } = useParams();  // :shopId từ URL\r\n  const { user } = useAuth();\r\n  const navigate = useNavigate();\r\n  const [messages, setMessages] = useState([]);\r\n  const [text, setText] = useState('');\r\n  const wsRef = useRef(null);\r\n  const bottomRef = useRef(null);\r\n\r\n  useEffect(() => {\r\n    if (!user) {\r\n      navigate('/login');\r\n      return;\r\n    }\r\n\r\n    const token = localStorage.getItem('access_token') || '';\r\n    const raw = API_BASE.replace(/^https?:\\/\\//, '');\r\n    const wsProtocol = API_BASE.startsWith('https') ? 'wss' : 'ws';\r\n    const params = new URLSearchParams(window.location.search);\r\n    const product = params.get('product');\r\n    const qs = new URLSearchParams({ token });\r\n    if (product) qs.set('product', product);\r\n    // Gửi luôn buyerId (user hiện tại) để backend phân biệt conversation\r\n    qs.set('buyer', user.user_id);\r\n\r\n    const wsUrl = `${wsProtocol}://${raw}/ws/chat/${shopId}/?${qs.toString()}`;\r\n    const ws = new WebSocket(wsUrl);\r\n    wsRef.current = ws;\r\n\r\n    ws.onopen = () => console.log('WS connected (buyer)');\r\n\r\n    ws.onmessage = (evt) => {\r\n      try {\r\n        const data = JSON.parse(evt.data);\r\n        if (data.type === 'history') setMessages(data.messages || []);\r\n        else if (data.type === 'message' && data.message)\r\n          setMessages(prev => [...prev, data.message]);\r\n      } catch (err) {\r\n        console.error('WS parse error:', err);\r\n      }\r\n    };\r\n\r\n    ws.onclose = (evt) => console.error('WS closed', { code: evt.code, reason: evt.reason });\r\n    ws.onerror = (e) => console.error('WS error', e);\r\n\r\n    return () => ws.close();\r\n  }, [shopId, user, navigate]);\r\n\r\n  useEffect(() => {\r\n    bottomRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n  }, [messages]);\r\n\r\n  const sendMessage = () => {\r\n    const content = text.trim();\r\n    if (!content || !wsRef.current || wsRef.current.readyState !== 1) return;\r\n    wsRef.current.send(JSON.stringify({ type: 'message', content }));\r\n    setText('');\r\n  };\r\n\r\n  if (!user) return null;\r\n\r\n  return (\r\n    <div style={{ maxWidth: 900, margin: '20px auto', display:'flex', flexDirection:'column', height:'80vh', background:'#fff', border:'1px solid #eee', borderRadius:8 }}>\r\n      <div style={{ padding:12, borderBottom:'1px solid #eee', display:'flex', alignItems:'center', justifyContent:'space-between' }}>\r\n        <Link to=\"/\">&larr; Trang chủ</Link>\r\n        <strong>Chat với shop #{shopId}</strong>\r\n      </div>\r\n      <div style={{ flex:1, overflowY:'auto', padding:12 }}>\r\n        {messages.map(m => (\r\n          <div key={m.id} style={{ marginBottom:8, display:'flex', justifyContent: m.sender_id === user?.user_id ? 'flex-end' : 'flex-start' }}>\r\n            <div style={{ maxWidth:'70%', padding:'8px 12px', borderRadius:12, background: m.sender_id === user?.user_id ? '#DCFCE7' : '#F3F4F6' }}>\r\n              <div style={{ fontSize:14 }}>{m.content}</div>\r\n              <div style={{ fontSize:11, color:'#6b7280', marginTop:4 }}>{new Date(m.created_at).toLocaleString('vi-VN')}</div>\r\n            </div>\r\n          </div>\r\n        ))}\r\n        <div ref={bottomRef} />\r\n      </div>\r\n      <div style={{ padding:12, display:'flex', gap:8, borderTop:'1px solid #eee' }}>\r\n        <input\r\n          value={text}\r\n          onChange={e => setText(e.target.value)}\r\n          onKeyDown={e => e.key==='Enter' && sendMessage()}\r\n          placeholder=\"Nhập nội dung...\"\r\n          style={{ flex:1, padding:'10px 12px', border:'1px solid #ddd', borderRadius:8 }}\r\n        />\r\n        <button onClick={sendMessage} style={{ padding:'10px 16px', background:'#2563eb', color:'#fff', border:'none', borderRadius:8 }}>Gửi</button>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}