{"ast":null,"code":"var _jsxFileName = \"C:\\\\VIET\\\\PBL6\\\\main\\\\frontend\\\\src\\\\components\\\\ChatWidget.jsx\",\n  _s = $RefreshSig$(),\n  _s2 = $RefreshSig$();\nimport React, { useCallback, useEffect, useMemo, useRef, useState } from 'react';\nimport { useAuth } from '../utils/AuthContext';\nimport { jsxDEV as _jsxDEV, Fragment as _Fragment } from \"react/jsx-dev-runtime\";\nconst API_BASE = process.env.REACT_APP_API_BASE || 'http://localhost:8000';\nconst formatRelativeTime = isoString => {\n  if (!isoString) return '';\n  const date = new Date(isoString);\n  const diff = Date.now() - date.getTime();\n  if (diff < 60000) return 'V·ª´a xong';\n  if (diff < 3600000) return `${Math.floor(diff / 60000)} ph√∫t tr∆∞·ªõc`;\n  if (diff < 86400000) return `${Math.floor(diff / 3600000)} gi·ªù tr∆∞·ªõc`;\n  return date.toLocaleDateString('vi-VN');\n};\nconst normalizeConversation = (raw = {}) => {\n  var _raw$shop, _raw$shop2, _raw$shop3, _raw$buyer, _raw$buyer2, _raw$product, _raw$product2;\n  return {\n    id: raw.id || raw.conversation_id || `${raw.shop_id || 'shop'}-${raw.buyer_id || 'buyer'}`,\n    shopId: raw.shop_id || ((_raw$shop = raw.shop) === null || _raw$shop === void 0 ? void 0 : _raw$shop.id) || raw.shopId,\n    shopName: raw.shop_name || ((_raw$shop2 = raw.shop) === null || _raw$shop2 === void 0 ? void 0 : _raw$shop2.name) || raw.shopName || `Shop #${raw.shop_id || raw.shopId || '?'}`,\n    shopAvatar: raw.shop_avatar || ((_raw$shop3 = raw.shop) === null || _raw$shop3 === void 0 ? void 0 : _raw$shop3.avatar),\n    buyerId: raw.buyer_id || ((_raw$buyer = raw.buyer) === null || _raw$buyer === void 0 ? void 0 : _raw$buyer.id) || raw.buyerId,\n    buyerName: raw.buyer_name || ((_raw$buyer2 = raw.buyer) === null || _raw$buyer2 === void 0 ? void 0 : _raw$buyer2.full_name) || raw.buyerName || `Kh√°ch #${raw.buyer_id || raw.buyerId || '?'}`,\n    productId: raw.product_id || ((_raw$product = raw.product) === null || _raw$product === void 0 ? void 0 : _raw$product.id),\n    productName: raw.product_name || ((_raw$product2 = raw.product) === null || _raw$product2 === void 0 ? void 0 : _raw$product2.name),\n    lastMessage: raw.last_message || raw.lastMessage || 'Ch∆∞a c√≥ tin nh·∫Øn',\n    updatedAt: raw.updated_at || raw.last_message_at || raw.updatedAt || new Date().toISOString(),\n    unreadCount: raw.unread_count || raw.unreadCount || 0\n  };\n};\nconst buildFallbackConversations = user => {\n  if (!user) return [];\n  const now = new Date();\n  return [{\n    id: 'demo-1',\n    shopId: user.user_type === 'seller' ? user.user_id : 101,\n    shopName: user.user_type === 'seller' ? 'Shop c·ªßa b·∫°n' : 'Shop th·ªùi trang',\n    buyerId: user.user_type === 'seller' ? 501 : user.user_id,\n    buyerName: user.user_type === 'seller' ? 'Kh√°ch m·ªõi' : 'B·∫°n',\n    productName: '√Åo cotton form r·ªông',\n    lastMessage: 'Xin ch√†o! Shop c√≤n size M kh√¥ng?',\n    updatedAt: now.toISOString(),\n    unreadCount: user.user_type === 'seller' ? 2 : 0\n  }, {\n    id: 'demo-2',\n    shopId: user.user_type === 'seller' ? user.user_id : 205,\n    shopName: user.user_type === 'seller' ? 'Shop c·ªßa b·∫°n' : 'Gi√†y Sneaker Pro',\n    buyerId: user.user_type === 'seller' ? 777 : user.user_id,\n    buyerName: user.user_type === 'seller' ? 'Nguy·ªÖn Tr√† My' : 'B·∫°n',\n    productName: 'Sneaker Runner X',\n    lastMessage: 'Shop ph·∫£n h·ªìi: S·∫£n ph·∫©m s·∫Ω giao trong h√¥m nay nha!',\n    updatedAt: new Date(now.getTime() - 3600000).toISOString(),\n    unreadCount: 0\n  }];\n};\nconst ChatWidget = () => {\n  _s();\n  const {\n    user\n  } = useAuth();\n  const [drawerOpen, setDrawerOpen] = useState(false);\n  const [conversations, setConversations] = useState([]);\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState('');\n  const [activeConversation, setActiveConversation] = useState(null);\n  const hasLoadedRef = useRef(false);\n  const [drawerHeight, setDrawerHeight] = useState(420);\n  const [isResizing, setIsResizing] = useState(false);\n  const resizeStateRef = useRef({\n    startY: 0,\n    startHeight: 420\n  });\n  const notificationSocketRef = useRef(null);\n  const audioContextRef = useRef(null);\n  const [toasts, setToasts] = useState([]);\n  const toastTimersRef = useRef({});\n  const [unreadTotal, setUnreadTotal] = useState(0);\n  const isSeller = (user === null || user === void 0 ? void 0 : user.user_type) === 'seller';\n  const fetchConversations = useCallback(async () => {\n    if (!user) return;\n    setLoading(true);\n    setError('');\n    try {\n      const token = localStorage.getItem('access_token');\n      if (!token) throw new Error('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng chat.');\n      const res = await fetch(`${API_BASE}/api/chat/conversations/`, {\n        headers: {\n          Authorization: `Bearer ${token}`\n        }\n      });\n      if (!res.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i cu·ªôc tr√≤ chuy·ªán.');\n      const data = await res.json();\n      const list = Array.isArray(data === null || data === void 0 ? void 0 : data.results) ? data.results : Array.isArray(data) ? data : [];\n      setConversations(list.map(normalizeConversation));\n      hasLoadedRef.current = true;\n    } catch (err) {\n      console.error('Fetch conversations error:', err);\n      if (!hasLoadedRef.current) {\n        setConversations(buildFallbackConversations(user).map(normalizeConversation));\n      }\n      setError(err.message || 'ƒê√£ x·∫£y ra l·ªói khi t·∫£i danh s√°ch cu·ªôc tr√≤ chuy·ªán.');\n    } finally {\n      setLoading(false);\n    }\n  }, [user]);\n  useEffect(() => {\n    setUnreadTotal(conversations.reduce((sum, item) => sum + (item.unreadCount || 0), 0));\n  }, [conversations]);\n  const ensureAudioContext = useCallback(() => {\n    const AudioContextClass = window.AudioContext || window.webkitAudioContext;\n    if (!AudioContextClass) return null;\n    if (!audioContextRef.current) {\n      audioContextRef.current = new AudioContextClass();\n    }\n    if (audioContextRef.current.state === 'suspended') {\n      audioContextRef.current.resume();\n    }\n    return audioContextRef.current;\n  }, []);\n  const playMessageChime = useCallback(() => {\n    const ctx = ensureAudioContext();\n    if (!ctx) return;\n    try {\n      const oscillator = ctx.createOscillator();\n      const gainNode = ctx.createGain();\n      oscillator.type = 'triangle';\n      oscillator.frequency.value = 920;\n      gainNode.gain.value = 0.08;\n      oscillator.connect(gainNode);\n      gainNode.connect(ctx.destination);\n      oscillator.start();\n      oscillator.stop(ctx.currentTime + 0.2);\n    } catch (err) {\n      console.warn('Unable to play sound', err);\n    }\n  }, [ensureAudioContext]);\n  const pushToast = useCallback(toast => {\n    var _window$crypto, _window$crypto$random;\n    const id = toast.id || ((_window$crypto = window.crypto) === null || _window$crypto === void 0 ? void 0 : (_window$crypto$random = _window$crypto.randomUUID) === null || _window$crypto$random === void 0 ? void 0 : _window$crypto$random.call(_window$crypto)) || `${Date.now()}-${Math.random()}`;\n    const nextToast = {\n      id,\n      title: toast.title || 'Th√¥ng b√°o',\n      message: toast.message || '',\n      meta: toast.meta || '',\n      accent: toast.accent || 'info'\n    };\n    setToasts(prev => [...prev, nextToast]);\n    const timeout = setTimeout(() => {\n      setToasts(prev => prev.filter(item => item.id !== id));\n    }, toast.duration || 6000);\n    toastTimersRef.current[id] = timeout;\n  }, []);\n  const dismissToast = useCallback(id => {\n    setToasts(prev => prev.filter(item => item.id !== id));\n    if (toastTimersRef.current[id]) {\n      clearTimeout(toastTimersRef.current[id]);\n      delete toastTimersRef.current[id];\n    }\n  }, []);\n  useEffect(() => {\n    if (drawerOpen && !hasLoadedRef.current) {\n      fetchConversations();\n    }\n  }, [drawerOpen, fetchConversations]);\n  useEffect(() => {\n    const timers = toastTimersRef.current;\n    return () => {\n      Object.values(timers).forEach(clearTimeout);\n    };\n  }, []);\n  const handleOrderAlert = useCallback(payload => {\n    if (!payload) return;\n    pushToast({\n      title: 'ƒê∆°n h√†ng c·∫≠p nh·∫≠t',\n      message: payload.message || `ƒê∆°n h√†ng #${payload.order_id} ƒë√£ c·∫≠p nh·∫≠t.`,\n      meta: payload.status_label,\n      accent: 'order'\n    });\n  }, [pushToast]);\n  const handleChatSummary = useCallback(payload => {\n    if (!(payload !== null && payload !== void 0 && payload.conversation_id)) return;\n    setConversations(prev => {\n      let exists = false;\n      const mapped = prev.map(conv => {\n        if (conv.id === payload.conversation_id) {\n          exists = true;\n          return {\n            ...conv,\n            lastMessage: payload.last_message || conv.lastMessage,\n            updatedAt: payload.last_message_at || conv.updatedAt,\n            unreadCount: typeof payload.unread_count === 'number' ? payload.unread_count : conv.unreadCount\n          };\n        }\n        return conv;\n      }).sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));\n      if (exists) {\n        return mapped;\n      }\n      const newcomer = normalizeConversation({\n        id: payload.conversation_id,\n        buyer_id: payload.buyer_id,\n        buyer_name: payload.buyer_name,\n        shop_id: payload.shop_id,\n        shop_name: payload.shop_name,\n        product_id: payload.product_id,\n        product_name: payload.product_name,\n        last_message: payload.last_message,\n        last_message_at: payload.last_message_at,\n        unread_count: payload.unread_count || 0\n      });\n      return [newcomer, ...mapped];\n    });\n    const isActive = (activeConversation === null || activeConversation === void 0 ? void 0 : activeConversation.id) === payload.conversation_id && drawerOpen;\n    if (!isActive && payload.sender_id !== (user === null || user === void 0 ? void 0 : user.user_id)) {\n      playMessageChime();\n    }\n  }, [activeConversation === null || activeConversation === void 0 ? void 0 : activeConversation.id, drawerOpen, playMessageChime, user === null || user === void 0 ? void 0 : user.user_id]);\n  const handleConversationActivity = useCallback((conversationId, latest = {}) => {\n    if (!conversationId) return;\n    setConversations(prev => {\n      let updated = false;\n      const mapped = prev.map(conv => {\n        if (conv.id !== conversationId) return conv;\n        updated = true;\n        return {\n          ...conv,\n          lastMessage: latest.lastMessage || conv.lastMessage,\n          updatedAt: latest.updatedAt || new Date().toISOString(),\n          unreadCount: typeof latest.unreadCount === 'number' ? latest.unreadCount : conv.unreadCount\n        };\n      }).sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));\n      return updated ? mapped : prev;\n    });\n  }, []);\n  useEffect(() => {\n    if (!user) return;\n    const token = localStorage.getItem('access_token');\n    if (!token) return;\n    const rawHost = API_BASE.replace(/^https?:\\/\\//, '');\n    const protocol = API_BASE.startsWith('https') ? 'wss' : 'ws';\n    const ws = new WebSocket(`${protocol}://${rawHost}/ws/notifications/?token=${token}`);\n    notificationSocketRef.current = ws;\n    ws.onmessage = event => {\n      try {\n        const data = JSON.parse(event.data);\n        if (data.type === 'order_status') handleOrderAlert(data);\n        if (data.type === 'chat_summary') handleChatSummary(data);\n      } catch (err) {\n        console.error('Notification WS parse error', err);\n      }\n    };\n    ws.onerror = err => console.error('Notification WS error', err);\n    ws.onclose = () => {\n      notificationSocketRef.current = null;\n    };\n    return () => ws.close();\n  }, [user, handleOrderAlert, handleChatSummary]);\n  const handleConversationClick = conversation => {\n    setActiveConversation(conversation);\n    setConversations(prev => prev.map(item => item.id === conversation.id ? {\n      ...item,\n      unreadCount: 0\n    } : item));\n  };\n  const counterpartLabel = conversation => {\n    if (!conversation) return '';\n    return isSeller ? conversation.buyerName : conversation.shopName;\n  };\n  const toggleDrawer = () => {\n    ensureAudioContext();\n    setDrawerOpen(prev => !prev);\n  };\n  const startResize = event => {\n    event.preventDefault();\n    const clientY = event.touches ? event.touches[0].clientY : event.clientY;\n    resizeStateRef.current = {\n      startY: clientY,\n      startHeight: drawerHeight\n    };\n    setIsResizing(true);\n  };\n  useEffect(() => {\n    if (!isResizing) return;\n    const handleMove = event => {\n      const clientY = event.touches ? event.touches[0].clientY : event.clientY;\n      const delta = resizeStateRef.current.startY - clientY;\n      const nextHeight = Math.max(260, Math.min(620, resizeStateRef.current.startHeight + delta));\n      setDrawerHeight(nextHeight);\n    };\n    const stopResize = () => setIsResizing(false);\n    window.addEventListener('mousemove', handleMove);\n    window.addEventListener('touchmove', handleMove);\n    window.addEventListener('mouseup', stopResize);\n    window.addEventListener('touchend', stopResize);\n    return () => {\n      window.removeEventListener('mousemove', handleMove);\n      window.removeEventListener('touchmove', handleMove);\n      window.removeEventListener('mouseup', stopResize);\n      window.removeEventListener('touchend', stopResize);\n    };\n  }, [isResizing]);\n  if (!user) return null;\n  return /*#__PURE__*/_jsxDEV(_Fragment, {\n    children: [/*#__PURE__*/_jsxDEV(\"button\", {\n      className: \"chat-floating-button\",\n      onClick: toggleDrawer,\n      \"aria-label\": \"M\\u1EDF chat\",\n      children: [\"\\uD83D\\uDCAC\", unreadTotal > 0 && /*#__PURE__*/_jsxDEV(\"span\", {\n        className: \"chat-floating-button__badge\",\n        children: unreadTotal > 99 ? '99+' : unreadTotal\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 345,\n        columnNumber: 11\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 338,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: `chat-drawer ${drawerOpen ? 'open' : ''} ${isResizing ? 'resizing' : ''}`,\n      style: {\n        height: `${drawerHeight}px`\n      },\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"chat-drawer__handle\",\n        role: \"presentation\",\n        onMouseDown: startResize,\n        onTouchStart: startResize\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 355,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"chat-drawer__header\",\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          children: [/*#__PURE__*/_jsxDEV(\"p\", {\n            children: \"H\\u1ED9p th\\u01B0\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 363,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(\"h4\", {\n            children: \"Cu\\u1ED9c tr\\xF2 chuy\\u1EC7n\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 364,\n            columnNumber: 13\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 362,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: () => setDrawerOpen(false),\n          \"aria-label\": \"\\u0110\\xF3ng chat\",\n          children: \"\\xD7\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 366,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 361,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"chat-drawer__body\",\n        children: [loading && /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"chat-drawer__empty\",\n          children: \"\\u0110ang t\\u1EA3i cu\\u1ED9c tr\\xF2 chuy\\u1EC7n...\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 370,\n          columnNumber: 23\n        }, this), !loading && error && /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"chat-drawer__error\",\n          children: error\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 371,\n          columnNumber: 33\n        }, this), !loading && !conversations.length && !error && /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"chat-drawer__empty\",\n          children: \"Ch\\u01B0a c\\xF3 cu\\u1ED9c tr\\xF2 chuy\\u1EC7n n\\xE0o.\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 373,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"chat-conversation-list\",\n          children: conversations.map(conversation => {\n            var _counterpartLabel;\n            return /*#__PURE__*/_jsxDEV(\"button\", {\n              className: `chat-conversation-item ${(activeConversation === null || activeConversation === void 0 ? void 0 : activeConversation.id) === conversation.id ? 'active' : ''}`,\n              onClick: () => handleConversationClick(conversation),\n              children: [/*#__PURE__*/_jsxDEV(\"div\", {\n                className: \"chat-conversation-item__avatar\",\n                children: conversation.shopAvatar ? /*#__PURE__*/_jsxDEV(\"img\", {\n                  src: conversation.shopAvatar,\n                  alt: conversation.shopName\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 387,\n                  columnNumber: 21\n                }, this) : /*#__PURE__*/_jsxDEV(\"span\", {\n                  children: (_counterpartLabel = counterpartLabel(conversation)) === null || _counterpartLabel === void 0 ? void 0 : _counterpartLabel.charAt(0)\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 389,\n                  columnNumber: 21\n                }, this)\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 385,\n                columnNumber: 17\n              }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n                className: \"chat-conversation-item__content\",\n                children: [/*#__PURE__*/_jsxDEV(\"div\", {\n                  className: \"chat-conversation-item__row\",\n                  children: [/*#__PURE__*/_jsxDEV(\"strong\", {\n                    children: counterpartLabel(conversation)\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 394,\n                    columnNumber: 21\n                  }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n                    children: formatRelativeTime(conversation.updatedAt)\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 395,\n                    columnNumber: 21\n                  }, this)]\n                }, void 0, true, {\n                  fileName: _jsxFileName,\n                  lineNumber: 393,\n                  columnNumber: 19\n                }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n                  children: [conversation.productName && /*#__PURE__*/_jsxDEV(\"em\", {\n                    children: [conversation.productName, \" \\u2022 \"]\n                  }, void 0, true, {\n                    fileName: _jsxFileName,\n                    lineNumber: 398,\n                    columnNumber: 50\n                  }, this), conversation.lastMessage]\n                }, void 0, true, {\n                  fileName: _jsxFileName,\n                  lineNumber: 397,\n                  columnNumber: 19\n                }, this)]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 392,\n                columnNumber: 17\n              }, this), conversation.unreadCount > 0 && /*#__PURE__*/_jsxDEV(\"span\", {\n                className: \"chat-conversation-item__badge\",\n                children: conversation.unreadCount\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 403,\n                columnNumber: 19\n              }, this)]\n            }, conversation.id, true, {\n              fileName: _jsxFileName,\n              lineNumber: 378,\n              columnNumber: 15\n            }, this);\n          })\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 376,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 369,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 351,\n      columnNumber: 7\n    }, this), activeConversation && /*#__PURE__*/_jsxDEV(ChatPopup, {\n      conversation: activeConversation,\n      onClose: () => setActiveConversation(null),\n      isSeller: isSeller,\n      counterpartName: counterpartLabel(activeConversation),\n      onIncomingMessage: playMessageChime,\n      onConversationActivity: handleConversationActivity\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 412,\n      columnNumber: 9\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"notification-toast-stack\",\n      children: toasts.map(toast => /*#__PURE__*/_jsxDEV(\"div\", {\n        className: `notification-toast notification-toast--${toast.accent}`,\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          children: [/*#__PURE__*/_jsxDEV(\"p\", {\n            children: toast.title\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 426,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"strong\", {\n            children: toast.message\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 427,\n            columnNumber: 15\n          }, this), toast.meta && /*#__PURE__*/_jsxDEV(\"span\", {\n            children: toast.meta\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 428,\n            columnNumber: 30\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 425,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: () => dismissToast(toast.id),\n          \"aria-label\": \"\\u0110\\xF3ng th\\xF4ng b\\xE1o\",\n          children: \"\\xD7\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 430,\n          columnNumber: 13\n        }, this)]\n      }, toast.id, true, {\n        fileName: _jsxFileName,\n        lineNumber: 424,\n        columnNumber: 11\n      }, this))\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 422,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true);\n};\n_s(ChatWidget, \"9TGiR6GQmd0AJt/HsoBAbNhJOqU=\", false, function () {\n  return [useAuth];\n});\n_c = ChatWidget;\nconst ChatPopup = ({\n  conversation,\n  onClose,\n  isSeller,\n  counterpartName,\n  onIncomingMessage,\n  onConversationActivity\n}) => {\n  _s2();\n  const {\n    user\n  } = useAuth();\n  const [messages, setMessages] = useState([]);\n  const [text, setText] = useState('');\n  const [connecting, setConnecting] = useState(false);\n  const wsRef = useRef(null);\n  const bottomRef = useRef(null);\n  const shopId = useMemo(() => {\n    if (isSeller) return conversation.shopId || (user === null || user === void 0 ? void 0 : user.user_id);\n    return conversation.shopId;\n  }, [conversation.shopId, isSeller, user === null || user === void 0 ? void 0 : user.user_id]);\n  const buyerParam = useMemo(() => {\n    if (isSeller) return conversation.buyerId;\n    return user === null || user === void 0 ? void 0 : user.user_id;\n  }, [conversation.buyerId, isSeller, user === null || user === void 0 ? void 0 : user.user_id]);\n  useEffect(() => {\n    if (!conversation || !shopId || !buyerParam || !user) return;\n    const token = localStorage.getItem('access_token') || '';\n    const raw = API_BASE.replace(/^https?:\\/\\//, '');\n    const wsProtocol = API_BASE.startsWith('https') ? 'wss' : 'ws';\n    const qs = new URLSearchParams({\n      token,\n      buyer: buyerParam\n    });\n    if (conversation.productId) qs.set('product', conversation.productId);\n    const wsUrl = `${wsProtocol}://${raw}/ws/chat/${shopId}/?${qs.toString()}`;\n    const ws = new WebSocket(wsUrl);\n    wsRef.current = ws;\n    setConnecting(true);\n    ws.onopen = () => setConnecting(false);\n    ws.onmessage = evt => {\n      try {\n        const data = JSON.parse(evt.data);\n        if (data.type === 'history') setMessages(data.messages || []);else if (data.type === 'message' && data.message) {\n          setMessages(prev => [...prev, data.message]);\n          if (data.message.sender_id !== (user === null || user === void 0 ? void 0 : user.user_id) && typeof onIncomingMessage === 'function') {\n            onIncomingMessage();\n          }\n          if (typeof onConversationActivity === 'function') {\n            onConversationActivity(conversation === null || conversation === void 0 ? void 0 : conversation.id, {\n              lastMessage: data.message.content,\n              updatedAt: data.message.created_at,\n              unreadCount: 0\n            });\n          }\n        }\n      } catch (error) {\n        console.error('WS parse error', error);\n      }\n    };\n    ws.onclose = evt => console.log('Chat popup WS closed', evt);\n    ws.onerror = error => console.error('Chat popup WS error', error);\n    return () => ws.close();\n  }, [conversation, buyerParam, shopId, user, onIncomingMessage, onConversationActivity]);\n  useEffect(() => {\n    var _bottomRef$current;\n    (_bottomRef$current = bottomRef.current) === null || _bottomRef$current === void 0 ? void 0 : _bottomRef$current.scrollIntoView({\n      behavior: 'smooth'\n    });\n  }, [messages]);\n  const sendMessage = () => {\n    const content = text.trim();\n    if (!content || !wsRef.current || wsRef.current.readyState !== 1) return;\n    wsRef.current.send(JSON.stringify({\n      type: 'message',\n      content\n    }));\n    setText('');\n  };\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"chat-popup\",\n    children: [/*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"chat-popup__header\",\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        children: [/*#__PURE__*/_jsxDEV(\"p\", {\n          children: conversation.productName || 'Tr√≤ chuy·ªán'\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 513,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"strong\", {\n          children: counterpartName\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 514,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 512,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n        onClick: onClose,\n        \"aria-label\": \"\\u0110\\xF3ng cu\\u1ED9c tr\\xF2 chuy\\u1EC7n\",\n        children: \"\\xD7\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 516,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 511,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"chat-popup__body\",\n      children: [connecting && /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"chat-popup__info\",\n        children: \"\\u0110ang k\\u1EBFt n\\u1ED1i...\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 520,\n        columnNumber: 24\n      }, this), messages.map(message => /*#__PURE__*/_jsxDEV(\"div\", {\n        className: `chat-popup__message ${message.sender_id === (user === null || user === void 0 ? void 0 : user.user_id) ? 'me' : ''}`,\n        children: /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"chat-popup__bubble\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            children: message.content\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 527,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n            children: new Date(message.created_at).toLocaleString('vi-VN')\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 528,\n            columnNumber: 15\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 526,\n          columnNumber: 13\n        }, this)\n      }, message.id || `${message.created_at}-${message.sender_id}`, false, {\n        fileName: _jsxFileName,\n        lineNumber: 522,\n        columnNumber: 11\n      }, this)), /*#__PURE__*/_jsxDEV(\"div\", {\n        ref: bottomRef\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 532,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 519,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"chat-popup__footer\",\n      children: [/*#__PURE__*/_jsxDEV(\"input\", {\n        value: text,\n        onChange: e => setText(e.target.value),\n        onKeyDown: e => e.key === 'Enter' && sendMessage(),\n        placeholder: \"Nh\\u1EADp n\\u1ED9i dung...\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 536,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n        onClick: sendMessage,\n        children: \"G\\u1EEDi\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 542,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 535,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 510,\n    columnNumber: 5\n  }, this);\n};\n_s2(ChatPopup, \"G9/phBfpy4p3hfowXRxJSXWsjXA=\", false, function () {\n  return [useAuth];\n});\n_c2 = ChatPopup;\nexport default ChatWidget;\nvar _c, _c2;\n$RefreshReg$(_c, \"ChatWidget\");\n$RefreshReg$(_c2, \"ChatPopup\");","map":{"version":3,"names":["React","useCallback","useEffect","useMemo","useRef","useState","useAuth","jsxDEV","_jsxDEV","Fragment","_Fragment","API_BASE","process","env","REACT_APP_API_BASE","formatRelativeTime","isoString","date","Date","diff","now","getTime","Math","floor","toLocaleDateString","normalizeConversation","raw","_raw$shop","_raw$shop2","_raw$shop3","_raw$buyer","_raw$buyer2","_raw$product","_raw$product2","id","conversation_id","shop_id","buyer_id","shopId","shop","shopName","shop_name","name","shopAvatar","shop_avatar","avatar","buyerId","buyer","buyerName","buyer_name","full_name","productId","product_id","product","productName","product_name","lastMessage","last_message","updatedAt","updated_at","last_message_at","toISOString","unreadCount","unread_count","buildFallbackConversations","user","user_type","user_id","ChatWidget","_s","drawerOpen","setDrawerOpen","conversations","setConversations","loading","setLoading","error","setError","activeConversation","setActiveConversation","hasLoadedRef","drawerHeight","setDrawerHeight","isResizing","setIsResizing","resizeStateRef","startY","startHeight","notificationSocketRef","audioContextRef","toasts","setToasts","toastTimersRef","unreadTotal","setUnreadTotal","isSeller","fetchConversations","token","localStorage","getItem","Error","res","fetch","headers","Authorization","ok","data","json","list","Array","isArray","results","map","current","err","console","message","reduce","sum","item","ensureAudioContext","AudioContextClass","window","AudioContext","webkitAudioContext","state","resume","playMessageChime","ctx","oscillator","createOscillator","gainNode","createGain","type","frequency","value","gain","connect","destination","start","stop","currentTime","warn","pushToast","toast","_window$crypto","_window$crypto$random","crypto","randomUUID","call","random","nextToast","title","meta","accent","prev","timeout","setTimeout","filter","duration","dismissToast","clearTimeout","timers","Object","values","forEach","handleOrderAlert","payload","order_id","status_label","handleChatSummary","exists","mapped","conv","sort","a","b","newcomer","isActive","sender_id","handleConversationActivity","conversationId","latest","updated","rawHost","replace","protocol","startsWith","ws","WebSocket","onmessage","event","JSON","parse","onerror","onclose","close","handleConversationClick","conversation","counterpartLabel","toggleDrawer","startResize","preventDefault","clientY","touches","handleMove","delta","nextHeight","max","min","stopResize","addEventListener","removeEventListener","children","className","onClick","fileName","_jsxFileName","lineNumber","columnNumber","style","height","role","onMouseDown","onTouchStart","length","_counterpartLabel","src","alt","charAt","ChatPopup","onClose","counterpartName","onIncomingMessage","onConversationActivity","_c","_s2","messages","setMessages","text","setText","connecting","setConnecting","wsRef","bottomRef","buyerParam","wsProtocol","qs","URLSearchParams","set","wsUrl","toString","onopen","evt","content","created_at","log","_bottomRef$current","scrollIntoView","behavior","sendMessage","trim","readyState","send","stringify","toLocaleString","ref","onChange","e","target","onKeyDown","key","placeholder","_c2","$RefreshReg$"],"sources":["C:/VIET/PBL6/main/frontend/src/components/ChatWidget.jsx"],"sourcesContent":["import React, { useCallback, useEffect, useMemo, useRef, useState } from 'react';\r\nimport { useAuth } from '../utils/AuthContext';\r\n\r\nconst API_BASE = process.env.REACT_APP_API_BASE || 'http://localhost:8000';\r\n\r\nconst formatRelativeTime = (isoString) => {\r\n  if (!isoString) return '';\r\n  const date = new Date(isoString);\r\n  const diff = Date.now() - date.getTime();\r\n  if (diff < 60000) return 'V·ª´a xong';\r\n  if (diff < 3600000) return `${Math.floor(diff / 60000)} ph√∫t tr∆∞·ªõc`;\r\n  if (diff < 86400000) return `${Math.floor(diff / 3600000)} gi·ªù tr∆∞·ªõc`;\r\n  return date.toLocaleDateString('vi-VN');\r\n};\r\n\r\nconst normalizeConversation = (raw = {}) => ({\r\n  id: raw.id || raw.conversation_id || `${raw.shop_id || 'shop'}-${raw.buyer_id || 'buyer'}`,\r\n  shopId: raw.shop_id || raw.shop?.id || raw.shopId,\r\n  shopName: raw.shop_name || raw.shop?.name || raw.shopName || `Shop #${raw.shop_id || raw.shopId || '?'}`,\r\n  shopAvatar: raw.shop_avatar || raw.shop?.avatar,\r\n  buyerId: raw.buyer_id || raw.buyer?.id || raw.buyerId,\r\n  buyerName: raw.buyer_name || raw.buyer?.full_name || raw.buyerName || `Kh√°ch #${raw.buyer_id || raw.buyerId || '?'}`,\r\n  productId: raw.product_id || raw.product?.id,\r\n  productName: raw.product_name || raw.product?.name,\r\n  lastMessage: raw.last_message || raw.lastMessage || 'Ch∆∞a c√≥ tin nh·∫Øn',\r\n  updatedAt: raw.updated_at || raw.last_message_at || raw.updatedAt || new Date().toISOString(),\r\n  unreadCount: raw.unread_count || raw.unreadCount || 0,\r\n});\r\n\r\nconst buildFallbackConversations = (user) => {\r\n  if (!user) return [];\r\n  const now = new Date();\r\n  return [\r\n    {\r\n      id: 'demo-1',\r\n      shopId: user.user_type === 'seller' ? user.user_id : 101,\r\n      shopName: user.user_type === 'seller' ? 'Shop c·ªßa b·∫°n' : 'Shop th·ªùi trang',\r\n      buyerId: user.user_type === 'seller' ? 501 : user.user_id,\r\n      buyerName: user.user_type === 'seller' ? 'Kh√°ch m·ªõi' : 'B·∫°n',\r\n      productName: '√Åo cotton form r·ªông',\r\n      lastMessage: 'Xin ch√†o! Shop c√≤n size M kh√¥ng?',\r\n      updatedAt: now.toISOString(),\r\n      unreadCount: user.user_type === 'seller' ? 2 : 0,\r\n    },\r\n    {\r\n      id: 'demo-2',\r\n      shopId: user.user_type === 'seller' ? user.user_id : 205,\r\n      shopName: user.user_type === 'seller' ? 'Shop c·ªßa b·∫°n' : 'Gi√†y Sneaker Pro',\r\n      buyerId: user.user_type === 'seller' ? 777 : user.user_id,\r\n      buyerName: user.user_type === 'seller' ? 'Nguy·ªÖn Tr√† My' : 'B·∫°n',\r\n      productName: 'Sneaker Runner X',\r\n      lastMessage: 'Shop ph·∫£n h·ªìi: S·∫£n ph·∫©m s·∫Ω giao trong h√¥m nay nha!',\r\n      updatedAt: new Date(now.getTime() - 3600000).toISOString(),\r\n      unreadCount: 0,\r\n    },\r\n  ];\r\n};\r\n\r\nconst ChatWidget = () => {\r\n  const { user } = useAuth();\r\n  const [drawerOpen, setDrawerOpen] = useState(false);\r\n  const [conversations, setConversations] = useState([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState('');\r\n  const [activeConversation, setActiveConversation] = useState(null);\r\n  const hasLoadedRef = useRef(false);\r\n  const [drawerHeight, setDrawerHeight] = useState(420);\r\n  const [isResizing, setIsResizing] = useState(false);\r\n  const resizeStateRef = useRef({ startY: 0, startHeight: 420 });\r\n  const notificationSocketRef = useRef(null);\r\n  const audioContextRef = useRef(null);\r\n  const [toasts, setToasts] = useState([]);\r\n  const toastTimersRef = useRef({});\r\n  const [unreadTotal, setUnreadTotal] = useState(0);\r\n\r\n  const isSeller = user?.user_type === 'seller';\r\n\r\n  const fetchConversations = useCallback(async () => {\r\n    if (!user) return;\r\n    setLoading(true);\r\n    setError('');\r\n    try {\r\n      const token = localStorage.getItem('access_token');\r\n      if (!token) throw new Error('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng chat.');\r\n      const res = await fetch(`${API_BASE}/api/chat/conversations/`, {\r\n        headers: {\r\n          Authorization: `Bearer ${token}`,\r\n        },\r\n      });\r\n      if (!res.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i cu·ªôc tr√≤ chuy·ªán.');\r\n      const data = await res.json();\r\n      const list = Array.isArray(data?.results) ? data.results : Array.isArray(data) ? data : [];\r\n      setConversations(list.map(normalizeConversation));\r\n      hasLoadedRef.current = true;\r\n    } catch (err) {\r\n      console.error('Fetch conversations error:', err);\r\n      if (!hasLoadedRef.current) {\r\n        setConversations(buildFallbackConversations(user).map(normalizeConversation));\r\n      }\r\n      setError(err.message || 'ƒê√£ x·∫£y ra l·ªói khi t·∫£i danh s√°ch cu·ªôc tr√≤ chuy·ªán.');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [user]);\r\n\r\n  useEffect(() => {\r\n    setUnreadTotal(conversations.reduce((sum, item) => sum + (item.unreadCount || 0), 0));\r\n  }, [conversations]);\r\n\r\n  const ensureAudioContext = useCallback(() => {\r\n    const AudioContextClass = window.AudioContext || window.webkitAudioContext;\r\n    if (!AudioContextClass) return null;\r\n    if (!audioContextRef.current) {\r\n      audioContextRef.current = new AudioContextClass();\r\n    }\r\n    if (audioContextRef.current.state === 'suspended') {\r\n      audioContextRef.current.resume();\r\n    }\r\n    return audioContextRef.current;\r\n  }, []);\r\n\r\n  const playMessageChime = useCallback(() => {\r\n    const ctx = ensureAudioContext();\r\n    if (!ctx) return;\r\n    try {\r\n      const oscillator = ctx.createOscillator();\r\n      const gainNode = ctx.createGain();\r\n      oscillator.type = 'triangle';\r\n      oscillator.frequency.value = 920;\r\n      gainNode.gain.value = 0.08;\r\n      oscillator.connect(gainNode);\r\n      gainNode.connect(ctx.destination);\r\n      oscillator.start();\r\n      oscillator.stop(ctx.currentTime + 0.2);\r\n    } catch (err) {\r\n      console.warn('Unable to play sound', err);\r\n    }\r\n  }, [ensureAudioContext]);\r\n\r\n  const pushToast = useCallback((toast) => {\r\n    const id = toast.id || window.crypto?.randomUUID?.() || `${Date.now()}-${Math.random()}`;\r\n    const nextToast = {\r\n      id,\r\n      title: toast.title || 'Th√¥ng b√°o',\r\n      message: toast.message || '',\r\n      meta: toast.meta || '',\r\n      accent: toast.accent || 'info',\r\n    };\r\n    setToasts((prev) => [...prev, nextToast]);\r\n    const timeout = setTimeout(() => {\r\n      setToasts((prev) => prev.filter((item) => item.id !== id));\r\n    }, toast.duration || 6000);\r\n    toastTimersRef.current[id] = timeout;\r\n  }, []);\r\n\r\n  const dismissToast = useCallback((id) => {\r\n    setToasts((prev) => prev.filter((item) => item.id !== id));\r\n    if (toastTimersRef.current[id]) {\r\n      clearTimeout(toastTimersRef.current[id]);\r\n      delete toastTimersRef.current[id];\r\n    }\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (drawerOpen && !hasLoadedRef.current) {\r\n      fetchConversations();\r\n    }\r\n  }, [drawerOpen, fetchConversations]);\r\n\r\n  useEffect(() => {\r\n    const timers = toastTimersRef.current;\r\n    return () => {\r\n      Object.values(timers).forEach(clearTimeout);\r\n    };\r\n  }, []);\r\n\r\n  const handleOrderAlert = useCallback(\r\n    (payload) => {\r\n      if (!payload) return;\r\n      pushToast({\r\n        title: 'ƒê∆°n h√†ng c·∫≠p nh·∫≠t',\r\n        message: payload.message || `ƒê∆°n h√†ng #${payload.order_id} ƒë√£ c·∫≠p nh·∫≠t.`,\r\n        meta: payload.status_label,\r\n        accent: 'order',\r\n      });\r\n    },\r\n    [pushToast]\r\n  );\r\n\r\n  const handleChatSummary = useCallback(\r\n    (payload) => {\r\n      if (!payload?.conversation_id) return;\r\n      setConversations((prev) => {\r\n        let exists = false;\r\n        const mapped = prev\r\n          .map((conv) => {\r\n            if (conv.id === payload.conversation_id) {\r\n              exists = true;\r\n              return {\r\n                ...conv,\r\n                lastMessage: payload.last_message || conv.lastMessage,\r\n                updatedAt: payload.last_message_at || conv.updatedAt,\r\n                unreadCount:\r\n                  typeof payload.unread_count === 'number' ? payload.unread_count : conv.unreadCount,\r\n              };\r\n            }\r\n            return conv;\r\n          })\r\n          .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));\r\n\r\n      if (exists) {\r\n        return mapped;\r\n      }\r\n\r\n      const newcomer = normalizeConversation({\r\n        id: payload.conversation_id,\r\n        buyer_id: payload.buyer_id,\r\n        buyer_name: payload.buyer_name,\r\n        shop_id: payload.shop_id,\r\n        shop_name: payload.shop_name,\r\n        product_id: payload.product_id,\r\n        product_name: payload.product_name,\r\n        last_message: payload.last_message,\r\n        last_message_at: payload.last_message_at,\r\n        unread_count: payload.unread_count || 0,\r\n      });\r\n      return [newcomer, ...mapped];\r\n      });\r\n\r\n      const isActive = activeConversation?.id === payload.conversation_id && drawerOpen;\r\n      if (!isActive && payload.sender_id !== user?.user_id) {\r\n        playMessageChime();\r\n      }\r\n    },\r\n    [activeConversation?.id, drawerOpen, playMessageChime, user?.user_id]\r\n  );\r\n\r\n  const handleConversationActivity = useCallback((conversationId, latest = {}) => {\r\n    if (!conversationId) return;\r\n    setConversations((prev) => {\r\n      let updated = false;\r\n      const mapped = prev\r\n        .map((conv) => {\r\n          if (conv.id !== conversationId) return conv;\r\n          updated = true;\r\n          return {\r\n            ...conv,\r\n            lastMessage: latest.lastMessage || conv.lastMessage,\r\n            updatedAt: latest.updatedAt || new Date().toISOString(),\r\n            unreadCount: typeof latest.unreadCount === 'number' ? latest.unreadCount : conv.unreadCount,\r\n          };\r\n        })\r\n        .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));\r\n      return updated ? mapped : prev;\r\n    });\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (!user) return;\r\n    const token = localStorage.getItem('access_token');\r\n    if (!token) return;\r\n\r\n    const rawHost = API_BASE.replace(/^https?:\\/\\//, '');\r\n    const protocol = API_BASE.startsWith('https') ? 'wss' : 'ws';\r\n    const ws = new WebSocket(`${protocol}://${rawHost}/ws/notifications/?token=${token}`);\r\n    notificationSocketRef.current = ws;\r\n\r\n    ws.onmessage = (event) => {\r\n      try {\r\n        const data = JSON.parse(event.data);\r\n        if (data.type === 'order_status') handleOrderAlert(data);\r\n        if (data.type === 'chat_summary') handleChatSummary(data);\r\n      } catch (err) {\r\n        console.error('Notification WS parse error', err);\r\n      }\r\n    };\r\n    ws.onerror = (err) => console.error('Notification WS error', err);\r\n    ws.onclose = () => {\r\n      notificationSocketRef.current = null;\r\n    };\r\n\r\n    return () => ws.close();\r\n  }, [user, handleOrderAlert, handleChatSummary]);\r\n\r\n  const handleConversationClick = (conversation) => {\r\n    setActiveConversation(conversation);\r\n    setConversations((prev) =>\r\n      prev.map((item) =>\r\n        item.id === conversation.id ? { ...item, unreadCount: 0 } : item\r\n      )\r\n    );\r\n  };\r\n\r\n  const counterpartLabel = (conversation) => {\r\n    if (!conversation) return '';\r\n    return isSeller ? conversation.buyerName : conversation.shopName;\r\n  };\r\n\r\n  const toggleDrawer = () => {\r\n    ensureAudioContext();\r\n    setDrawerOpen((prev) => !prev);\r\n  };\r\n\r\n  const startResize = (event) => {\r\n    event.preventDefault();\r\n    const clientY = event.touches ? event.touches[0].clientY : event.clientY;\r\n    resizeStateRef.current = { startY: clientY, startHeight: drawerHeight };\r\n    setIsResizing(true);\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (!isResizing) return;\r\n    const handleMove = (event) => {\r\n      const clientY = event.touches ? event.touches[0].clientY : event.clientY;\r\n      const delta = resizeStateRef.current.startY - clientY;\r\n      const nextHeight = Math.max(260, Math.min(620, resizeStateRef.current.startHeight + delta));\r\n      setDrawerHeight(nextHeight);\r\n    };\r\n    const stopResize = () => setIsResizing(false);\r\n\r\n    window.addEventListener('mousemove', handleMove);\r\n    window.addEventListener('touchmove', handleMove);\r\n    window.addEventListener('mouseup', stopResize);\r\n    window.addEventListener('touchend', stopResize);\r\n\r\n    return () => {\r\n      window.removeEventListener('mousemove', handleMove);\r\n      window.removeEventListener('touchmove', handleMove);\r\n      window.removeEventListener('mouseup', stopResize);\r\n      window.removeEventListener('touchend', stopResize);\r\n    };\r\n  }, [isResizing]);\r\n\r\n  if (!user) return null;\r\n\r\n  return (\r\n    <>\r\n      <button\r\n        className=\"chat-floating-button\"\r\n        onClick={toggleDrawer}\r\n        aria-label=\"M·ªü chat\"\r\n      >\r\n        üí¨\r\n        {unreadTotal > 0 && (\r\n          <span className=\"chat-floating-button__badge\">\r\n            {unreadTotal > 99 ? '99+' : unreadTotal}\r\n          </span>\r\n        )}\r\n      </button>\r\n\r\n      <div\r\n        className={`chat-drawer ${drawerOpen ? 'open' : ''} ${isResizing ? 'resizing' : ''}`}\r\n        style={{ height: `${drawerHeight}px` }}\r\n      >\r\n        <div\r\n          className=\"chat-drawer__handle\"\r\n          role=\"presentation\"\r\n          onMouseDown={startResize}\r\n          onTouchStart={startResize}\r\n        />\r\n        <div className=\"chat-drawer__header\">\r\n          <div>\r\n            <p>H·ªôp th∆∞</p>\r\n            <h4>Cu·ªôc tr√≤ chuy·ªán</h4>\r\n          </div>\r\n          <button onClick={() => setDrawerOpen(false)} aria-label=\"ƒê√≥ng chat\">√ó</button>\r\n        </div>\r\n\r\n        <div className=\"chat-drawer__body\">\r\n          {loading && <div className=\"chat-drawer__empty\">ƒêang t·∫£i cu·ªôc tr√≤ chuy·ªán...</div>}\r\n          {!loading && error && <div className=\"chat-drawer__error\">{error}</div>}\r\n          {!loading && !conversations.length && !error && (\r\n            <div className=\"chat-drawer__empty\">Ch∆∞a c√≥ cu·ªôc tr√≤ chuy·ªán n√†o.</div>\r\n          )}\r\n\r\n          <div className=\"chat-conversation-list\">\r\n            {conversations.map((conversation) => (\r\n              <button\r\n                key={conversation.id}\r\n                className={`chat-conversation-item ${\r\n                  activeConversation?.id === conversation.id ? 'active' : ''\r\n                }`}\r\n                onClick={() => handleConversationClick(conversation)}\r\n              >\r\n                <div className=\"chat-conversation-item__avatar\">\r\n                  {conversation.shopAvatar ? (\r\n                    <img src={conversation.shopAvatar} alt={conversation.shopName} />\r\n                  ) : (\r\n                    <span>{counterpartLabel(conversation)?.charAt(0)}</span>\r\n                  )}\r\n                </div>\r\n                <div className=\"chat-conversation-item__content\">\r\n                  <div className=\"chat-conversation-item__row\">\r\n                    <strong>{counterpartLabel(conversation)}</strong>\r\n                    <span>{formatRelativeTime(conversation.updatedAt)}</span>\r\n                  </div>\r\n                  <p>\r\n                    {conversation.productName && <em>{conversation.productName} ‚Ä¢ </em>}\r\n                    {conversation.lastMessage}\r\n                  </p>\r\n                </div>\r\n                {conversation.unreadCount > 0 && (\r\n                  <span className=\"chat-conversation-item__badge\">{conversation.unreadCount}</span>\r\n                )}\r\n              </button>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {activeConversation && (\r\n        <ChatPopup\r\n          conversation={activeConversation}\r\n          onClose={() => setActiveConversation(null)}\r\n          isSeller={isSeller}\r\n          counterpartName={counterpartLabel(activeConversation)}\r\n          onIncomingMessage={playMessageChime}\r\n          onConversationActivity={handleConversationActivity}\r\n        />\r\n      )}\r\n\r\n      <div className=\"notification-toast-stack\">\r\n        {toasts.map((toast) => (\r\n          <div key={toast.id} className={`notification-toast notification-toast--${toast.accent}`}>\r\n            <div>\r\n              <p>{toast.title}</p>\r\n              <strong>{toast.message}</strong>\r\n              {toast.meta && <span>{toast.meta}</span>}\r\n            </div>\r\n            <button onClick={() => dismissToast(toast.id)} aria-label=\"ƒê√≥ng th√¥ng b√°o\">√ó</button>\r\n          </div>\r\n        ))}\r\n      </div>\r\n    </>\r\n  );\r\n};\r\n\r\nconst ChatPopup = ({ conversation, onClose, isSeller, counterpartName, onIncomingMessage, onConversationActivity }) => {\r\n  const { user } = useAuth();\r\n  const [messages, setMessages] = useState([]);\r\n  const [text, setText] = useState('');\r\n  const [connecting, setConnecting] = useState(false);\r\n  const wsRef = useRef(null);\r\n  const bottomRef = useRef(null);\r\n\r\n  const shopId = useMemo(() => {\r\n    if (isSeller) return conversation.shopId || user?.user_id;\r\n    return conversation.shopId;\r\n  }, [conversation.shopId, isSeller, user?.user_id]);\r\n\r\n  const buyerParam = useMemo(() => {\r\n    if (isSeller) return conversation.buyerId;\r\n    return user?.user_id;\r\n  }, [conversation.buyerId, isSeller, user?.user_id]);\r\n\r\n  useEffect(() => {\r\n    if (!conversation || !shopId || !buyerParam || !user) return;\r\n\r\n    const token = localStorage.getItem('access_token') || '';\r\n    const raw = API_BASE.replace(/^https?:\\/\\//, '');\r\n    const wsProtocol = API_BASE.startsWith('https') ? 'wss' : 'ws';\r\n    const qs = new URLSearchParams({ token, buyer: buyerParam });\r\n    if (conversation.productId) qs.set('product', conversation.productId);\r\n\r\n    const wsUrl = `${wsProtocol}://${raw}/ws/chat/${shopId}/?${qs.toString()}`;\r\n    const ws = new WebSocket(wsUrl);\r\n    wsRef.current = ws;\r\n    setConnecting(true);\r\n\r\n    ws.onopen = () => setConnecting(false);\r\n    ws.onmessage = (evt) => {\r\n      try {\r\n        const data = JSON.parse(evt.data);\r\n        if (data.type === 'history') setMessages(data.messages || []);\r\n        else if (data.type === 'message' && data.message) {\r\n          setMessages((prev) => [...prev, data.message]);\r\n          if (data.message.sender_id !== user?.user_id && typeof onIncomingMessage === 'function') {\r\n            onIncomingMessage();\r\n          }\r\n          if (typeof onConversationActivity === 'function') {\r\n            onConversationActivity(conversation?.id, {\r\n              lastMessage: data.message.content,\r\n              updatedAt: data.message.created_at,\r\n              unreadCount: 0,\r\n            });\r\n          }\r\n        }\r\n      } catch (error) {\r\n        console.error('WS parse error', error);\r\n      }\r\n    };\r\n    ws.onclose = (evt) => console.log('Chat popup WS closed', evt);\r\n    ws.onerror = (error) => console.error('Chat popup WS error', error);\r\n\r\n    return () => ws.close();\r\n  }, [conversation, buyerParam, shopId, user, onIncomingMessage, onConversationActivity]);\r\n\r\n  useEffect(() => {\r\n    bottomRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n  }, [messages]);\r\n\r\n  const sendMessage = () => {\r\n    const content = text.trim();\r\n    if (!content || !wsRef.current || wsRef.current.readyState !== 1) return;\r\n    wsRef.current.send(JSON.stringify({ type: 'message', content }));\r\n    setText('');\r\n  };\r\n\r\n  return (\r\n    <div className=\"chat-popup\">\r\n      <div className=\"chat-popup__header\">\r\n        <div>\r\n          <p>{conversation.productName || 'Tr√≤ chuy·ªán'}</p>\r\n          <strong>{counterpartName}</strong>\r\n        </div>\r\n        <button onClick={onClose} aria-label=\"ƒê√≥ng cu·ªôc tr√≤ chuy·ªán\">√ó</button>\r\n      </div>\r\n\r\n      <div className=\"chat-popup__body\">\r\n        {connecting && <div className=\"chat-popup__info\">ƒêang k·∫øt n·ªëi...</div>}\r\n        {messages.map((message) => (\r\n          <div\r\n            key={message.id || `${message.created_at}-${message.sender_id}`}\r\n            className={`chat-popup__message ${message.sender_id === user?.user_id ? 'me' : ''}`}\r\n          >\r\n            <div className=\"chat-popup__bubble\">\r\n              <div>{message.content}</div>\r\n              <span>{new Date(message.created_at).toLocaleString('vi-VN')}</span>\r\n            </div>\r\n          </div>\r\n        ))}\r\n        <div ref={bottomRef} />\r\n      </div>\r\n\r\n      <div className=\"chat-popup__footer\">\r\n        <input\r\n          value={text}\r\n          onChange={(e) => setText(e.target.value)}\r\n          onKeyDown={(e) => e.key === 'Enter' && sendMessage()}\r\n          placeholder=\"Nh·∫≠p n·ªôi dung...\"\r\n        />\r\n        <button onClick={sendMessage}>G·ª≠i</button>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ChatWidget;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}