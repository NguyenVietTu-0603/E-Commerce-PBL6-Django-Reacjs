{"ast":null,"code":"var _jsxFileName = \"C:\\\\VIET\\\\PBL6\\\\main\\\\frontend\\\\src\\\\components\\\\ChatWidget.jsx\",\n  _s = $RefreshSig$(),\n  _s2 = $RefreshSig$();\nimport React, { useCallback, useEffect, useMemo, useRef, useState } from 'react';\nimport { useAuth } from '../utils/AuthContext';\nimport { jsxDEV as _jsxDEV, Fragment as _Fragment } from \"react/jsx-dev-runtime\";\nconst API_BASE = process.env.REACT_APP_API_BASE || 'http://localhost:8000';\nconst formatRelativeTime = isoString => {\n  if (!isoString) return '';\n  const date = new Date(isoString);\n  const diff = Date.now() - date.getTime();\n  if (diff < 60000) return 'V·ª´a xong';\n  if (diff < 3600000) return `${Math.floor(diff / 60000)} ph√∫t tr∆∞·ªõc`;\n  if (diff < 86400000) return `${Math.floor(diff / 3600000)} gi·ªù tr∆∞·ªõc`;\n  return date.toLocaleDateString('vi-VN');\n};\nconst normalizeConversation = (raw = {}) => {\n  var _raw$shop, _raw$shop2, _raw$shop3, _raw$buyer, _raw$buyer2, _raw$product, _raw$product2;\n  return {\n    id: raw.id || raw.conversation_id || `${raw.shop_id || 'shop'}-${raw.buyer_id || 'buyer'}`,\n    shopId: raw.shop_id || ((_raw$shop = raw.shop) === null || _raw$shop === void 0 ? void 0 : _raw$shop.id) || raw.shopId,\n    shopName: raw.shop_name || ((_raw$shop2 = raw.shop) === null || _raw$shop2 === void 0 ? void 0 : _raw$shop2.name) || raw.shopName || `Shop #${raw.shop_id || raw.shopId || '?'}`,\n    shopAvatar: raw.shop_avatar || ((_raw$shop3 = raw.shop) === null || _raw$shop3 === void 0 ? void 0 : _raw$shop3.avatar),\n    buyerId: raw.buyer_id || ((_raw$buyer = raw.buyer) === null || _raw$buyer === void 0 ? void 0 : _raw$buyer.id) || raw.buyerId,\n    buyerName: raw.buyer_name || ((_raw$buyer2 = raw.buyer) === null || _raw$buyer2 === void 0 ? void 0 : _raw$buyer2.full_name) || raw.buyerName || `Kh√°ch #${raw.buyer_id || raw.buyerId || '?'}`,\n    productId: raw.product_id || ((_raw$product = raw.product) === null || _raw$product === void 0 ? void 0 : _raw$product.id),\n    productName: raw.product_name || ((_raw$product2 = raw.product) === null || _raw$product2 === void 0 ? void 0 : _raw$product2.name),\n    lastMessage: raw.last_message || raw.lastMessage || 'Ch∆∞a c√≥ tin nh·∫Øn',\n    updatedAt: raw.updated_at || raw.last_message_at || raw.updatedAt || new Date().toISOString(),\n    unreadCount: raw.unread_count || raw.unreadCount || 0\n  };\n};\nconst buildFallbackConversations = user => {\n  if (!user) return [];\n  const now = new Date();\n  return [{\n    id: 'demo-1',\n    shopId: user.user_type === 'seller' ? user.user_id : 101,\n    shopName: user.user_type === 'seller' ? 'Shop c·ªßa b·∫°n' : 'Shop th·ªùi trang',\n    buyerId: user.user_type === 'seller' ? 501 : user.user_id,\n    buyerName: user.user_type === 'seller' ? 'Kh√°ch m·ªõi' : 'B·∫°n',\n    productName: '√Åo cotton form r·ªông',\n    lastMessage: 'Xin ch√†o! Shop c√≤n size M kh√¥ng?',\n    updatedAt: now.toISOString(),\n    unreadCount: user.user_type === 'seller' ? 2 : 0\n  }, {\n    id: 'demo-2',\n    shopId: user.user_type === 'seller' ? user.user_id : 205,\n    shopName: user.user_type === 'seller' ? 'Shop c·ªßa b·∫°n' : 'Gi√†y Sneaker Pro',\n    buyerId: user.user_type === 'seller' ? 777 : user.user_id,\n    buyerName: user.user_type === 'seller' ? 'Nguy·ªÖn Tr√† My' : 'B·∫°n',\n    productName: 'Sneaker Runner X',\n    lastMessage: 'Shop ph·∫£n h·ªìi: S·∫£n ph·∫©m s·∫Ω giao trong h√¥m nay nha!',\n    updatedAt: new Date(now.getTime() - 3600000).toISOString(),\n    unreadCount: 0\n  }];\n};\nconst ChatWidget = () => {\n  _s();\n  const {\n    user\n  } = useAuth();\n  const [drawerOpen, setDrawerOpen] = useState(false);\n  const [conversations, setConversations] = useState([]);\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState('');\n  const [activeConversation, setActiveConversation] = useState(null);\n  const hasLoadedRef = useRef(false);\n  const isSeller = (user === null || user === void 0 ? void 0 : user.user_type) === 'seller';\n  const fetchConversations = useCallback(async () => {\n    if (!user) return;\n    setLoading(true);\n    setError('');\n    try {\n      const token = localStorage.getItem('access_token');\n      if (!token) throw new Error('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng chat.');\n      const res = await fetch(`${API_BASE}/api/chat/conversations/`, {\n        headers: {\n          Authorization: `Bearer ${token}`\n        }\n      });\n      if (!res.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i cu·ªôc tr√≤ chuy·ªán.');\n      const data = await res.json();\n      const list = Array.isArray(data === null || data === void 0 ? void 0 : data.results) ? data.results : Array.isArray(data) ? data : [];\n      setConversations(list.map(normalizeConversation));\n      hasLoadedRef.current = true;\n    } catch (err) {\n      console.error('Fetch conversations error:', err);\n      if (!hasLoadedRef.current) {\n        setConversations(buildFallbackConversations(user).map(normalizeConversation));\n      }\n      setError(err.message || 'ƒê√£ x·∫£y ra l·ªói khi t·∫£i danh s√°ch cu·ªôc tr√≤ chuy·ªán.');\n    } finally {\n      setLoading(false);\n    }\n  }, [user]);\n  useEffect(() => {\n    if (drawerOpen && !hasLoadedRef.current) {\n      fetchConversations();\n    }\n  }, [drawerOpen, fetchConversations]);\n  if (!user) return null;\n  const handleConversationClick = conversation => {\n    setActiveConversation(conversation);\n  };\n  const counterpartLabel = conversation => {\n    if (!conversation) return '';\n    return isSeller ? conversation.buyerName : conversation.shopName;\n  };\n  return /*#__PURE__*/_jsxDEV(_Fragment, {\n    children: [/*#__PURE__*/_jsxDEV(\"button\", {\n      className: \"chat-floating-button\",\n      onClick: () => setDrawerOpen(prev => !prev),\n      \"aria-label\": \"M\\u1EDF chat\",\n      children: \"\\uD83D\\uDCAC\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 117,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: `chat-drawer ${drawerOpen ? 'open' : ''}`,\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"chat-drawer__header\",\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          children: [/*#__PURE__*/_jsxDEV(\"p\", {\n            children: \"H\\u1ED9p th\\u01B0\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 128,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(\"h4\", {\n            children: \"Cu\\u1ED9c tr\\xF2 chuy\\u1EC7n\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 129,\n            columnNumber: 13\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 127,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: () => setDrawerOpen(false),\n          \"aria-label\": \"\\u0110\\xF3ng chat\",\n          children: \"\\xD7\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 131,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 126,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"chat-drawer__body\",\n        children: [loading && /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"chat-drawer__empty\",\n          children: \"\\u0110ang t\\u1EA3i cu\\u1ED9c tr\\xF2 chuy\\u1EC7n...\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 135,\n          columnNumber: 23\n        }, this), !loading && error && /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"chat-drawer__error\",\n          children: error\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 136,\n          columnNumber: 33\n        }, this), !loading && !conversations.length && !error && /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"chat-drawer__empty\",\n          children: \"Ch\\u01B0a c\\xF3 cu\\u1ED9c tr\\xF2 chuy\\u1EC7n n\\xE0o.\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 138,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"chat-conversation-list\",\n          children: conversations.map(conversation => {\n            var _counterpartLabel;\n            return /*#__PURE__*/_jsxDEV(\"button\", {\n              className: `chat-conversation-item ${(activeConversation === null || activeConversation === void 0 ? void 0 : activeConversation.id) === conversation.id ? 'active' : ''}`,\n              onClick: () => handleConversationClick(conversation),\n              children: [/*#__PURE__*/_jsxDEV(\"div\", {\n                className: \"chat-conversation-item__avatar\",\n                children: conversation.shopAvatar ? /*#__PURE__*/_jsxDEV(\"img\", {\n                  src: conversation.shopAvatar,\n                  alt: conversation.shopName\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 152,\n                  columnNumber: 21\n                }, this) : /*#__PURE__*/_jsxDEV(\"span\", {\n                  children: (_counterpartLabel = counterpartLabel(conversation)) === null || _counterpartLabel === void 0 ? void 0 : _counterpartLabel.charAt(0)\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 154,\n                  columnNumber: 21\n                }, this)\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 150,\n                columnNumber: 17\n              }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n                className: \"chat-conversation-item__content\",\n                children: [/*#__PURE__*/_jsxDEV(\"div\", {\n                  className: \"chat-conversation-item__row\",\n                  children: [/*#__PURE__*/_jsxDEV(\"strong\", {\n                    children: counterpartLabel(conversation)\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 159,\n                    columnNumber: 21\n                  }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n                    children: formatRelativeTime(conversation.updatedAt)\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 160,\n                    columnNumber: 21\n                  }, this)]\n                }, void 0, true, {\n                  fileName: _jsxFileName,\n                  lineNumber: 158,\n                  columnNumber: 19\n                }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n                  children: [conversation.productName && /*#__PURE__*/_jsxDEV(\"em\", {\n                    children: [conversation.productName, \" \\u2022 \"]\n                  }, void 0, true, {\n                    fileName: _jsxFileName,\n                    lineNumber: 163,\n                    columnNumber: 50\n                  }, this), conversation.lastMessage]\n                }, void 0, true, {\n                  fileName: _jsxFileName,\n                  lineNumber: 162,\n                  columnNumber: 19\n                }, this)]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 157,\n                columnNumber: 17\n              }, this), conversation.unreadCount > 0 && /*#__PURE__*/_jsxDEV(\"span\", {\n                className: \"chat-conversation-item__badge\",\n                children: conversation.unreadCount\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 168,\n                columnNumber: 19\n              }, this)]\n            }, conversation.id, true, {\n              fileName: _jsxFileName,\n              lineNumber: 143,\n              columnNumber: 15\n            }, this);\n          })\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 141,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 134,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 125,\n      columnNumber: 7\n    }, this), activeConversation && /*#__PURE__*/_jsxDEV(ChatPopup, {\n      conversation: activeConversation,\n      onClose: () => setActiveConversation(null),\n      isSeller: isSeller,\n      counterpartName: counterpartLabel(activeConversation)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 177,\n      columnNumber: 9\n    }, this)]\n  }, void 0, true);\n};\n_s(ChatWidget, \"gq/zLgx0ojVn3FsmDjogEjFHXi8=\", false, function () {\n  return [useAuth];\n});\n_c = ChatWidget;\nconst ChatPopup = ({\n  conversation,\n  onClose,\n  isSeller,\n  counterpartName\n}) => {\n  _s2();\n  const {\n    user\n  } = useAuth();\n  const [messages, setMessages] = useState([]);\n  const [text, setText] = useState('');\n  const [connecting, setConnecting] = useState(false);\n  const wsRef = useRef(null);\n  const bottomRef = useRef(null);\n  const shopId = useMemo(() => {\n    if (isSeller) return conversation.shopId || (user === null || user === void 0 ? void 0 : user.user_id);\n    return conversation.shopId;\n  }, [conversation.shopId, isSeller, user === null || user === void 0 ? void 0 : user.user_id]);\n  const buyerParam = useMemo(() => {\n    if (isSeller) return conversation.buyerId;\n    return user === null || user === void 0 ? void 0 : user.user_id;\n  }, [conversation.buyerId, isSeller, user === null || user === void 0 ? void 0 : user.user_id]);\n  useEffect(() => {\n    if (!conversation || !shopId || !buyerParam || !user) return;\n    const token = localStorage.getItem('access_token') || '';\n    const raw = API_BASE.replace(/^https?:\\/\\//, '');\n    const wsProtocol = API_BASE.startsWith('https') ? 'wss' : 'ws';\n    const qs = new URLSearchParams({\n      token,\n      buyer: buyerParam\n    });\n    if (conversation.productId) qs.set('product', conversation.productId);\n    const wsUrl = `${wsProtocol}://${raw}/ws/chat/${shopId}/?${qs.toString()}`;\n    const ws = new WebSocket(wsUrl);\n    wsRef.current = ws;\n    setConnecting(true);\n    ws.onopen = () => setConnecting(false);\n    ws.onmessage = evt => {\n      try {\n        const data = JSON.parse(evt.data);\n        if (data.type === 'history') setMessages(data.messages || []);else if (data.type === 'message' && data.message) setMessages(prev => [...prev, data.message]);\n      } catch (error) {\n        console.error('WS parse error', error);\n      }\n    };\n    ws.onclose = evt => console.log('Chat popup WS closed', evt);\n    ws.onerror = error => console.error('Chat popup WS error', error);\n    return () => ws.close();\n  }, [conversation, buyerParam, shopId, user]);\n  useEffect(() => {\n    var _bottomRef$current;\n    (_bottomRef$current = bottomRef.current) === null || _bottomRef$current === void 0 ? void 0 : _bottomRef$current.scrollIntoView({\n      behavior: 'smooth'\n    });\n  }, [messages]);\n  const sendMessage = () => {\n    const content = text.trim();\n    if (!content || !wsRef.current || wsRef.current.readyState !== 1) return;\n    wsRef.current.send(JSON.stringify({\n      type: 'message',\n      content\n    }));\n    setText('');\n  };\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"chat-popup\",\n    children: [/*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"chat-popup__header\",\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        children: [/*#__PURE__*/_jsxDEV(\"p\", {\n          children: conversation.productName || 'Tr√≤ chuy·ªán'\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 251,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"strong\", {\n          children: counterpartName\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 252,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 250,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n        onClick: onClose,\n        \"aria-label\": \"\\u0110\\xF3ng cu\\u1ED9c tr\\xF2 chuy\\u1EC7n\",\n        children: \"\\xD7\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 254,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 249,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"chat-popup__body\",\n      children: [connecting && /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"chat-popup__info\",\n        children: \"\\u0110ang k\\u1EBFt n\\u1ED1i...\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 258,\n        columnNumber: 24\n      }, this), messages.map(message => /*#__PURE__*/_jsxDEV(\"div\", {\n        className: `chat-popup__message ${message.sender_id === (user === null || user === void 0 ? void 0 : user.user_id) ? 'me' : ''}`,\n        children: /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"chat-popup__bubble\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            children: message.content\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 265,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n            children: new Date(message.created_at).toLocaleString('vi-VN')\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 266,\n            columnNumber: 15\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 264,\n          columnNumber: 13\n        }, this)\n      }, message.id || `${message.created_at}-${message.sender_id}`, false, {\n        fileName: _jsxFileName,\n        lineNumber: 260,\n        columnNumber: 11\n      }, this)), /*#__PURE__*/_jsxDEV(\"div\", {\n        ref: bottomRef\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 270,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 257,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"chat-popup__footer\",\n      children: [/*#__PURE__*/_jsxDEV(\"input\", {\n        value: text,\n        onChange: e => setText(e.target.value),\n        onKeyDown: e => e.key === 'Enter' && sendMessage(),\n        placeholder: \"Nh\\u1EADp n\\u1ED9i dung...\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 274,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n        onClick: sendMessage,\n        children: \"G\\u1EEDi\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 280,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 273,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 248,\n    columnNumber: 5\n  }, this);\n};\n_s2(ChatPopup, \"G9/phBfpy4p3hfowXRxJSXWsjXA=\", false, function () {\n  return [useAuth];\n});\n_c2 = ChatPopup;\nexport default ChatWidget;\nvar _c, _c2;\n$RefreshReg$(_c, \"ChatWidget\");\n$RefreshReg$(_c2, \"ChatPopup\");","map":{"version":3,"names":["React","useCallback","useEffect","useMemo","useRef","useState","useAuth","jsxDEV","_jsxDEV","Fragment","_Fragment","API_BASE","process","env","REACT_APP_API_BASE","formatRelativeTime","isoString","date","Date","diff","now","getTime","Math","floor","toLocaleDateString","normalizeConversation","raw","_raw$shop","_raw$shop2","_raw$shop3","_raw$buyer","_raw$buyer2","_raw$product","_raw$product2","id","conversation_id","shop_id","buyer_id","shopId","shop","shopName","shop_name","name","shopAvatar","shop_avatar","avatar","buyerId","buyer","buyerName","buyer_name","full_name","productId","product_id","product","productName","product_name","lastMessage","last_message","updatedAt","updated_at","last_message_at","toISOString","unreadCount","unread_count","buildFallbackConversations","user","user_type","user_id","ChatWidget","_s","drawerOpen","setDrawerOpen","conversations","setConversations","loading","setLoading","error","setError","activeConversation","setActiveConversation","hasLoadedRef","isSeller","fetchConversations","token","localStorage","getItem","Error","res","fetch","headers","Authorization","ok","data","json","list","Array","isArray","results","map","current","err","console","message","handleConversationClick","conversation","counterpartLabel","children","className","onClick","prev","fileName","_jsxFileName","lineNumber","columnNumber","length","_counterpartLabel","src","alt","charAt","ChatPopup","onClose","counterpartName","_c","_s2","messages","setMessages","text","setText","connecting","setConnecting","wsRef","bottomRef","buyerParam","replace","wsProtocol","startsWith","qs","URLSearchParams","set","wsUrl","toString","ws","WebSocket","onopen","onmessage","evt","JSON","parse","type","onclose","log","onerror","close","_bottomRef$current","scrollIntoView","behavior","sendMessage","content","trim","readyState","send","stringify","sender_id","created_at","toLocaleString","ref","value","onChange","e","target","onKeyDown","key","placeholder","_c2","$RefreshReg$"],"sources":["C:/VIET/PBL6/main/frontend/src/components/ChatWidget.jsx"],"sourcesContent":["import React, { useCallback, useEffect, useMemo, useRef, useState } from 'react';\r\nimport { useAuth } from '../utils/AuthContext';\r\n\r\nconst API_BASE = process.env.REACT_APP_API_BASE || 'http://localhost:8000';\r\n\r\nconst formatRelativeTime = (isoString) => {\r\n  if (!isoString) return '';\r\n  const date = new Date(isoString);\r\n  const diff = Date.now() - date.getTime();\r\n  if (diff < 60000) return 'V·ª´a xong';\r\n  if (diff < 3600000) return `${Math.floor(diff / 60000)} ph√∫t tr∆∞·ªõc`;\r\n  if (diff < 86400000) return `${Math.floor(diff / 3600000)} gi·ªù tr∆∞·ªõc`;\r\n  return date.toLocaleDateString('vi-VN');\r\n};\r\n\r\nconst normalizeConversation = (raw = {}) => ({\r\n  id: raw.id || raw.conversation_id || `${raw.shop_id || 'shop'}-${raw.buyer_id || 'buyer'}`,\r\n  shopId: raw.shop_id || raw.shop?.id || raw.shopId,\r\n  shopName: raw.shop_name || raw.shop?.name || raw.shopName || `Shop #${raw.shop_id || raw.shopId || '?'}`,\r\n  shopAvatar: raw.shop_avatar || raw.shop?.avatar,\r\n  buyerId: raw.buyer_id || raw.buyer?.id || raw.buyerId,\r\n  buyerName: raw.buyer_name || raw.buyer?.full_name || raw.buyerName || `Kh√°ch #${raw.buyer_id || raw.buyerId || '?'}`,\r\n  productId: raw.product_id || raw.product?.id,\r\n  productName: raw.product_name || raw.product?.name,\r\n  lastMessage: raw.last_message || raw.lastMessage || 'Ch∆∞a c√≥ tin nh·∫Øn',\r\n  updatedAt: raw.updated_at || raw.last_message_at || raw.updatedAt || new Date().toISOString(),\r\n  unreadCount: raw.unread_count || raw.unreadCount || 0,\r\n});\r\n\r\nconst buildFallbackConversations = (user) => {\r\n  if (!user) return [];\r\n  const now = new Date();\r\n  return [\r\n    {\r\n      id: 'demo-1',\r\n      shopId: user.user_type === 'seller' ? user.user_id : 101,\r\n      shopName: user.user_type === 'seller' ? 'Shop c·ªßa b·∫°n' : 'Shop th·ªùi trang',\r\n      buyerId: user.user_type === 'seller' ? 501 : user.user_id,\r\n      buyerName: user.user_type === 'seller' ? 'Kh√°ch m·ªõi' : 'B·∫°n',\r\n      productName: '√Åo cotton form r·ªông',\r\n      lastMessage: 'Xin ch√†o! Shop c√≤n size M kh√¥ng?',\r\n      updatedAt: now.toISOString(),\r\n      unreadCount: user.user_type === 'seller' ? 2 : 0,\r\n    },\r\n    {\r\n      id: 'demo-2',\r\n      shopId: user.user_type === 'seller' ? user.user_id : 205,\r\n      shopName: user.user_type === 'seller' ? 'Shop c·ªßa b·∫°n' : 'Gi√†y Sneaker Pro',\r\n      buyerId: user.user_type === 'seller' ? 777 : user.user_id,\r\n      buyerName: user.user_type === 'seller' ? 'Nguy·ªÖn Tr√† My' : 'B·∫°n',\r\n      productName: 'Sneaker Runner X',\r\n      lastMessage: 'Shop ph·∫£n h·ªìi: S·∫£n ph·∫©m s·∫Ω giao trong h√¥m nay nha!',\r\n      updatedAt: new Date(now.getTime() - 3600000).toISOString(),\r\n      unreadCount: 0,\r\n    },\r\n  ];\r\n};\r\n\r\nconst ChatWidget = () => {\r\n  const { user } = useAuth();\r\n  const [drawerOpen, setDrawerOpen] = useState(false);\r\n  const [conversations, setConversations] = useState([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState('');\r\n  const [activeConversation, setActiveConversation] = useState(null);\r\n  const hasLoadedRef = useRef(false);\r\n\r\n  const isSeller = user?.user_type === 'seller';\r\n\r\n  const fetchConversations = useCallback(async () => {\r\n    if (!user) return;\r\n    setLoading(true);\r\n    setError('');\r\n    try {\r\n      const token = localStorage.getItem('access_token');\r\n      if (!token) throw new Error('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng chat.');\r\n      const res = await fetch(`${API_BASE}/api/chat/conversations/`, {\r\n        headers: {\r\n          Authorization: `Bearer ${token}`,\r\n        },\r\n      });\r\n      if (!res.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i cu·ªôc tr√≤ chuy·ªán.');\r\n      const data = await res.json();\r\n      const list = Array.isArray(data?.results) ? data.results : Array.isArray(data) ? data : [];\r\n      setConversations(list.map(normalizeConversation));\r\n      hasLoadedRef.current = true;\r\n    } catch (err) {\r\n      console.error('Fetch conversations error:', err);\r\n      if (!hasLoadedRef.current) {\r\n        setConversations(buildFallbackConversations(user).map(normalizeConversation));\r\n      }\r\n      setError(err.message || 'ƒê√£ x·∫£y ra l·ªói khi t·∫£i danh s√°ch cu·ªôc tr√≤ chuy·ªán.');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [user]);\r\n\r\n  useEffect(() => {\r\n    if (drawerOpen && !hasLoadedRef.current) {\r\n      fetchConversations();\r\n    }\r\n  }, [drawerOpen, fetchConversations]);\r\n\r\n  if (!user) return null;\r\n\r\n  const handleConversationClick = (conversation) => {\r\n    setActiveConversation(conversation);\r\n  };\r\n\r\n  const counterpartLabel = (conversation) => {\r\n    if (!conversation) return '';\r\n    return isSeller ? conversation.buyerName : conversation.shopName;\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <button\r\n        className=\"chat-floating-button\"\r\n        onClick={() => setDrawerOpen((prev) => !prev)}\r\n        aria-label=\"M·ªü chat\"\r\n      >\r\n        üí¨\r\n      </button>\r\n\r\n      <div className={`chat-drawer ${drawerOpen ? 'open' : ''}`}>\r\n        <div className=\"chat-drawer__header\">\r\n          <div>\r\n            <p>H·ªôp th∆∞</p>\r\n            <h4>Cu·ªôc tr√≤ chuy·ªán</h4>\r\n          </div>\r\n          <button onClick={() => setDrawerOpen(false)} aria-label=\"ƒê√≥ng chat\">√ó</button>\r\n        </div>\r\n\r\n        <div className=\"chat-drawer__body\">\r\n          {loading && <div className=\"chat-drawer__empty\">ƒêang t·∫£i cu·ªôc tr√≤ chuy·ªán...</div>}\r\n          {!loading && error && <div className=\"chat-drawer__error\">{error}</div>}\r\n          {!loading && !conversations.length && !error && (\r\n            <div className=\"chat-drawer__empty\">Ch∆∞a c√≥ cu·ªôc tr√≤ chuy·ªán n√†o.</div>\r\n          )}\r\n\r\n          <div className=\"chat-conversation-list\">\r\n            {conversations.map((conversation) => (\r\n              <button\r\n                key={conversation.id}\r\n                className={`chat-conversation-item ${\r\n                  activeConversation?.id === conversation.id ? 'active' : ''\r\n                }`}\r\n                onClick={() => handleConversationClick(conversation)}\r\n              >\r\n                <div className=\"chat-conversation-item__avatar\">\r\n                  {conversation.shopAvatar ? (\r\n                    <img src={conversation.shopAvatar} alt={conversation.shopName} />\r\n                  ) : (\r\n                    <span>{counterpartLabel(conversation)?.charAt(0)}</span>\r\n                  )}\r\n                </div>\r\n                <div className=\"chat-conversation-item__content\">\r\n                  <div className=\"chat-conversation-item__row\">\r\n                    <strong>{counterpartLabel(conversation)}</strong>\r\n                    <span>{formatRelativeTime(conversation.updatedAt)}</span>\r\n                  </div>\r\n                  <p>\r\n                    {conversation.productName && <em>{conversation.productName} ‚Ä¢ </em>}\r\n                    {conversation.lastMessage}\r\n                  </p>\r\n                </div>\r\n                {conversation.unreadCount > 0 && (\r\n                  <span className=\"chat-conversation-item__badge\">{conversation.unreadCount}</span>\r\n                )}\r\n              </button>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {activeConversation && (\r\n        <ChatPopup\r\n          conversation={activeConversation}\r\n          onClose={() => setActiveConversation(null)}\r\n          isSeller={isSeller}\r\n          counterpartName={counterpartLabel(activeConversation)}\r\n        />\r\n      )}\r\n    </>\r\n  );\r\n};\r\n\r\nconst ChatPopup = ({ conversation, onClose, isSeller, counterpartName }) => {\r\n  const { user } = useAuth();\r\n  const [messages, setMessages] = useState([]);\r\n  const [text, setText] = useState('');\r\n  const [connecting, setConnecting] = useState(false);\r\n  const wsRef = useRef(null);\r\n  const bottomRef = useRef(null);\r\n\r\n  const shopId = useMemo(() => {\r\n    if (isSeller) return conversation.shopId || user?.user_id;\r\n    return conversation.shopId;\r\n  }, [conversation.shopId, isSeller, user?.user_id]);\r\n\r\n  const buyerParam = useMemo(() => {\r\n    if (isSeller) return conversation.buyerId;\r\n    return user?.user_id;\r\n  }, [conversation.buyerId, isSeller, user?.user_id]);\r\n\r\n  useEffect(() => {\r\n    if (!conversation || !shopId || !buyerParam || !user) return;\r\n\r\n    const token = localStorage.getItem('access_token') || '';\r\n    const raw = API_BASE.replace(/^https?:\\/\\//, '');\r\n    const wsProtocol = API_BASE.startsWith('https') ? 'wss' : 'ws';\r\n    const qs = new URLSearchParams({ token, buyer: buyerParam });\r\n    if (conversation.productId) qs.set('product', conversation.productId);\r\n\r\n    const wsUrl = `${wsProtocol}://${raw}/ws/chat/${shopId}/?${qs.toString()}`;\r\n    const ws = new WebSocket(wsUrl);\r\n    wsRef.current = ws;\r\n    setConnecting(true);\r\n\r\n    ws.onopen = () => setConnecting(false);\r\n    ws.onmessage = (evt) => {\r\n      try {\r\n        const data = JSON.parse(evt.data);\r\n        if (data.type === 'history') setMessages(data.messages || []);\r\n        else if (data.type === 'message' && data.message) setMessages((prev) => [...prev, data.message]);\r\n      } catch (error) {\r\n        console.error('WS parse error', error);\r\n      }\r\n    };\r\n    ws.onclose = (evt) => console.log('Chat popup WS closed', evt);\r\n    ws.onerror = (error) => console.error('Chat popup WS error', error);\r\n\r\n    return () => ws.close();\r\n  }, [conversation, buyerParam, shopId, user]);\r\n\r\n  useEffect(() => {\r\n    bottomRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n  }, [messages]);\r\n\r\n  const sendMessage = () => {\r\n    const content = text.trim();\r\n    if (!content || !wsRef.current || wsRef.current.readyState !== 1) return;\r\n    wsRef.current.send(JSON.stringify({ type: 'message', content }));\r\n    setText('');\r\n  };\r\n\r\n  return (\r\n    <div className=\"chat-popup\">\r\n      <div className=\"chat-popup__header\">\r\n        <div>\r\n          <p>{conversation.productName || 'Tr√≤ chuy·ªán'}</p>\r\n          <strong>{counterpartName}</strong>\r\n        </div>\r\n        <button onClick={onClose} aria-label=\"ƒê√≥ng cu·ªôc tr√≤ chuy·ªán\">√ó</button>\r\n      </div>\r\n\r\n      <div className=\"chat-popup__body\">\r\n        {connecting && <div className=\"chat-popup__info\">ƒêang k·∫øt n·ªëi...</div>}\r\n        {messages.map((message) => (\r\n          <div\r\n            key={message.id || `${message.created_at}-${message.sender_id}`}\r\n            className={`chat-popup__message ${message.sender_id === user?.user_id ? 'me' : ''}`}\r\n          >\r\n            <div className=\"chat-popup__bubble\">\r\n              <div>{message.content}</div>\r\n              <span>{new Date(message.created_at).toLocaleString('vi-VN')}</span>\r\n            </div>\r\n          </div>\r\n        ))}\r\n        <div ref={bottomRef} />\r\n      </div>\r\n\r\n      <div className=\"chat-popup__footer\">\r\n        <input\r\n          value={text}\r\n          onChange={(e) => setText(e.target.value)}\r\n          onKeyDown={(e) => e.key === 'Enter' && sendMessage()}\r\n          placeholder=\"Nh·∫≠p n·ªôi dung...\"\r\n        />\r\n        <button onClick={sendMessage}>G·ª≠i</button>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ChatWidget;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}